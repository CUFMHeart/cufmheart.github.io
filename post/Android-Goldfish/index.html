<!DOCTYPE html>
<html lang="en">
    <!-- title -->




<!-- keywords -->




<head><meta name="generator" content="Hexo 3.9.0">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="author" content="CUFMH2">
    <meta name="renderer" content="webkit">
    <meta name="copyright" content="CUFMH2">
    
    <meta name="keywords" content="CUFMH,cufmheart">
    
    <meta name="description" content>
    <meta name="description" content="Android - Goldfish简介 Goldfish 是一款具有 互动交友、视频 Feeds 功能的广播式社交 APP。 开发环境 操作系统：MacOS、Windows IDE：Android Studio、GoLand  功能信息 用户登录、用户注册、用户退出登录 基于关注机制、发现机制实现短视频信息的分享 用户关注、用户取消关注 发布短视频，可设定私密、仅关注可见、公开可见三种权限">
<meta property="og:type" content="article">
<meta property="og:title" content="Android - Goldfish">
<meta property="og:url" content="https://cufmheart.github.io/post/Android-Goldfish/index.html">
<meta property="og:site_name" content="CUFMH2Blog">
<meta property="og:description" content="Android - Goldfish简介 Goldfish 是一款具有 互动交友、视频 Feeds 功能的广播式社交 APP。 开发环境 操作系统：MacOS、Windows IDE：Android Studio、GoLand  功能信息 用户登录、用户注册、用户退出登录 基于关注机制、发现机制实现短视频信息的分享 用户关注、用户取消关注 发布短视频，可设定私密、仅关注可见、公开可见三种权限">
<meta property="og:locale" content="en">
<meta property="og:image" content="https://cufmheart.github.io/post/Android-Goldfish/goldfish_icon.png">
<meta property="og:image" content="https://cufmheart.github.io/post/Android-Goldfish/image-20200716161438011.png">
<meta property="og:image" content="https://cufmheart.github.io/post/Android-Goldfish/image-20200716161457136.png">
<meta property="og:image" content="https://cufmheart.github.io/post/Android-Goldfish/image-20200716161545339.png">
<meta property="og:image" content="https://cufmheart.github.io/post/Android-Goldfish/image-20200716161557264.png">
<meta property="og:image" content="https://cufmheart.github.io/post/Android-Goldfish/image-20200716161610263.png">
<meta property="og:image" content="https://cufmheart.github.io/post/Android-Goldfish/image-20200716161617457.png">
<meta property="og:image" content="https://cufmheart.github.io/post/Android-Goldfish/image-20200716161627515.png">
<meta property="og:image" content="https://cufmheart.github.io/post/Android-Goldfish/image-20200716161637384.png">
<meta property="og:image" content="https://cufmheart.github.io/post/Android-Goldfish/image-20200716161650044.png">
<meta property="og:image" content="https://cufmheart.github.io/post/Android-Goldfish/image-20200716161701810.png">
<meta property="og:image" content="https://cufmheart.github.io/post/Android-Goldfish/image-20200716161726363.png">
<meta property="og:image" content="https://cufmheart.github.io/post/Android-Goldfish/image-20200716161737216.png">
<meta property="og:image" content="https://cufmheart.github.io/post/Android-Goldfish/image-20200716161833803.png">
<meta property="og:image" content="https://cufmheart.github.io/post/Android-Goldfish/image-20200716161854135.png">
<meta property="og:image" content="https://cufmheart.github.io/post/Android-Goldfish/class_directory1.png">
<meta property="og:image" content="https://cufmheart.github.io/post/Android-Goldfish/class_directory2.png">
<meta property="og:image" content="https://cufmheart.github.io/post/Android-Goldfish/data_flow.png">
<meta property="og:image" content="https://cufmheart.github.io/post/Android-Goldfish/query_explain_1.png">
<meta property="og:image" content="https://cufmheart.github.io/post/Android-Goldfish/query_explain_2.png">
<meta property="og:image" content="https://cufmheart.github.io/post/Android-Goldfish/query_explain_3.png">
<meta property="og:image" content="https://cufmheart.github.io/post/Android-Goldfish/query_explain_4.png">
<meta property="og:updated_time" content="2020-08-17T02:09:59.841Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Android - Goldfish">
<meta name="twitter:description" content="Android - Goldfish简介 Goldfish 是一款具有 互动交友、视频 Feeds 功能的广播式社交 APP。 开发环境 操作系统：MacOS、Windows IDE：Android Studio、GoLand  功能信息 用户登录、用户注册、用户退出登录 基于关注机制、发现机制实现短视频信息的分享 用户关注、用户取消关注 发布短视频，可设定私密、仅关注可见、公开可见三种权限">
<meta name="twitter:image" content="https://cufmheart.github.io/post/Android-Goldfish/goldfish_icon.png">
    <meta http-equiv="Cache-control" content="no-cache">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    
    <title>Android - Goldfish · CUFMH2Blog</title>
    <style type="text/css">
    @font-face {
        font-family: 'Oswald-Regular';
        src: url("/font/Oswald-Regular.ttf");
    }

    body {
        margin: 0;
    }

    header,
    footer,
    .back-top,
    .sidebar,
    .container,
    .site-intro-meta,
    .toc-wrapper {
        display: none;
    }

    .site-intro {
        position: relative;
        z-index: 3;
        width: 100%;
        /* height: 50vh; */
        overflow: hidden;
    }

    .site-intro-placeholder {
        position: absolute;
        z-index: -2;
        top: 0;
        left: 0;
        width: calc(100% + 300px);
        height: 100%;
        background: repeating-linear-gradient(-45deg, #444 0, #444 80px, #333 80px, #333 160px);
        background-position: center center;
        transform: translate3d(-226px, 0, 0);
        animation: gradient-move 2.5s ease-out 0s infinite;
    }

    @keyframes gradient-move {
        0% {
            transform: translate3d(-226px, 0, 0);
        }
        100% {
            transform: translate3d(0, 0, 0);
        }
    }

</style>

    <link rel="preload" href="/css/style.css?v=20180824" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <link rel="stylesheet" href="/css/mobile.css?v=20180824" media="(max-width: 980px)">
    
    <link rel="preload" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.2.5/jquery.fancybox.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
    
    <!-- /*! loadCSS. [c]2017 Filament Group, Inc. MIT License */
/* This file is meant as a standalone workflow for
- testing support for link[rel=preload]
- enabling async CSS loading in browsers that do not support rel=preload
- applying rel preload css once loaded, whether supported or not.
*/ -->
<script>
(function( w ){
	"use strict";
	// rel=preload support test
	if( !w.loadCSS ){
		w.loadCSS = function(){};
	}
	// define on the loadCSS obj
	var rp = loadCSS.relpreload = {};
	// rel=preload feature support test
	// runs once and returns a function for compat purposes
	rp.support = (function(){
		var ret;
		try {
			ret = w.document.createElement( "link" ).relList.supports( "preload" );
		} catch (e) {
			ret = false;
		}
		return function(){
			return ret;
		};
	})();

	// if preload isn't supported, get an asynchronous load by using a non-matching media attribute
	// then change that media back to its intended value on load
	rp.bindMediaToggle = function( link ){
		// remember existing media attr for ultimate state, or default to 'all'
		var finalMedia = link.media || "all";

		function enableStylesheet(){
			link.media = finalMedia;
		}

		// bind load handlers to enable media
		if( link.addEventListener ){
			link.addEventListener( "load", enableStylesheet );
		} else if( link.attachEvent ){
			link.attachEvent( "onload", enableStylesheet );
		}

		// Set rel and non-applicable media type to start an async request
		// note: timeout allows this to happen async to let rendering continue in IE
		setTimeout(function(){
			link.rel = "stylesheet";
			link.media = "only x";
		});
		// also enable media after 3 seconds,
		// which will catch very old browsers (android 2.x, old firefox) that don't support onload on link
		setTimeout( enableStylesheet, 3000 );
	};

	// loop through link elements in DOM
	rp.poly = function(){
		// double check this to prevent external calls from running
		if( rp.support() ){
			return;
		}
		var links = w.document.getElementsByTagName( "link" );
		for( var i = 0; i < links.length; i++ ){
			var link = links[ i ];
			// qualify links to those with rel=preload and as=style attrs
			if( link.rel === "preload" && link.getAttribute( "as" ) === "style" && !link.getAttribute( "data-loadcss" ) ){
				// prevent rerunning on link
				link.setAttribute( "data-loadcss", true );
				// bind listeners to toggle media back
				rp.bindMediaToggle( link );
			}
		}
	};

	// if unsupported, run the polyfill
	if( !rp.support() ){
		// run once at least
		rp.poly();

		// rerun poly on an interval until onload
		var run = w.setInterval( rp.poly, 500 );
		if( w.addEventListener ){
			w.addEventListener( "load", function(){
				rp.poly();
				w.clearInterval( run );
			} );
		} else if( w.attachEvent ){
			w.attachEvent( "onload", function(){
				rp.poly();
				w.clearInterval( run );
			} );
		}
	}


	// commonjs
	if( typeof exports !== "undefined" ){
		exports.loadCSS = loadCSS;
	}
	else {
		w.loadCSS = loadCSS;
	}
}( typeof global !== "undefined" ? global : this ) );
</script>

    <link rel="icon" href="/avatar/icon_128x1282.png">
    <link rel="preload" href="https://cdn.jsdelivr.net/npm/webfontloader@1.6.28/webfontloader.min.js" as="script">
    <link rel="preload" href="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js" as="script">
    <link rel="preload" href="/scripts/main.js" as="script">
    <link rel="preload" as="font" href="/font/Oswald-Regular.ttf" crossorigin>
    <link rel="preload" as="font" href="https://at.alicdn.com/t/font_327081_1dta1rlogw17zaor.woff" crossorigin>
    
    <!-- fancybox -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.2.5/jquery.fancybox.min.js" defer></script>
    <!-- 百度统计  -->
    
    <!-- 谷歌统计  -->
    
</head>

    
        <body class="post-body">
    
    
<header class="header">

    <div class="read-progress"></div>
    <div class="header-sidebar-menu">&#xe775;</div>
    <!-- post页的toggle banner  -->
    
    <div class="banner">
            <div class="blog-title">
                <a href="/" >CUFMH2Blog</a>
            </div>
            <div class="post-title">
                <a href="#" class="post-name">Android - Goldfish</a>
            </div>
    </div>
    
    <a class="home-link" href=/>CUFMH2Blog</a>
</header>
    <div class="wrapper">
        <div class="site-intro" style="







height:40vh;
">
    
    <!-- 主页  -->
    
    
    <!-- 404页  -->
            
    <div class="site-intro-placeholder"></div>
    <div class="site-intro-img" style="background-image: url(/intro/post-bg.png)"></div>
    <div class="site-intro-meta">
        <!-- 标题  -->
        <h1 class="intro-title">
            <!-- 主页  -->
            
            Android - Goldfish
            <!-- 404 -->
            
        </h1>
        <!-- 副标题 -->
        <p class="intro-subtitle">
            <!-- 主页副标题  -->
            
            
            <!-- 404 -->
            
        </p>
        <!-- 文章页meta -->
        
            <div class="post-intros">
                <!-- 文章页标签  -->
                
                
                    <div class="post-intro-read">
                        <span>
                            Word count: 
                                <span class="post-count word-count">8.2k</span>
                            Reading time: 
                                <span class="post-count reading-time">36 min</span>
                        </span>

                    </div>
                
                <div class="post-intro-meta">
                    <span class="post-intro-calander iconfont-archer power">&#xe676;</span>
                    <span class="post-intro-time">2020-08-01</span>
                    
                        <span id="busuanzi_container_page_pv" class="busuanzi-pv">
                            <span class="iconfont-archer">&#xe604;</span>
                            <span id="busuanzi_value_page_pv">calculating</span>
                        </span>
                    
                    <span class="shareWrapper">
                        <span class="iconfont-archer shareIcon">&#xe71d;</span>
                        <span class="shareText">Share</span>
                        <ul class="shareList">
                            <li class="iconfont-archer share-qr" data-type="qr">&#xe75b;
                                <div class="share-qrcode"></div>
                            </li>
                            <li class="iconfont-archer" data-type="weibo">&#xe619;</li>
                            <li class="iconfont-archer" data-type="qzone">&#xe62e;</li>
                            <li class="iconfont-archer" data-type="twitter">&#xe634;</li>
                            <li class="iconfont-archer" data-type="facebook">&#xe67a;</li>
                        </ul>
                    </span>

                </div>
            </div>
        
    </div>
</div>
        <script>
 
  // get user agent
  var browser = {
    versions: function () {
      var u = window.navigator.userAgent;
      return {
        userAgent: u,
        trident: u.indexOf('Trident') > -1, //IE内核
        presto: u.indexOf('Presto') > -1, //opera内核
        webKit: u.indexOf('AppleWebKit') > -1, //苹果、谷歌内核
        gecko: u.indexOf('Gecko') > -1 && u.indexOf('KHTML') == -1, //火狐内核
        mobile: !!u.match(/AppleWebKit.*Mobile.*/), //是否为移动终端
        ios: !!u.match(/\(i[^;]+;( U;)? CPU.+Mac OS X/), //ios终端
        android: u.indexOf('Android') > -1 || u.indexOf('Linux') > -1, //android终端或者uc浏览器
        iPhone: u.indexOf('iPhone') > -1 || u.indexOf('Mac') > -1, //是否为iPhone或者安卓QQ浏览器
        iPad: u.indexOf('iPad') > -1, //是否为iPad
        webApp: u.indexOf('Safari') == -1, //是否为web应用程序，没有头部与底部
        weixin: u.indexOf('MicroMessenger') == -1, //是否为微信浏览器
        uc: u.indexOf('UCBrowser') > -1 //是否为android下的UC浏览器
      };
    }()
  }
  console.log("userAgent:" + browser.versions.userAgent);

  // callback
  function fontLoaded() {
    console.log('font loaded');
    if (document.getElementsByClassName('site-intro-meta')) {
      document.getElementsByClassName('intro-title')[0].classList.add('intro-fade-in');
      document.getElementsByClassName('intro-subtitle')[0].classList.add('intro-fade-in');
      var postIntros = document.getElementsByClassName('post-intros')[0]
      if (postIntros) {
        postIntros.classList.add('post-fade-in');
      }
    }
  }

  // UC不支持跨域，所以直接显示
  function asyncCb(){
    if (browser.versions.uc) {
      console.log("UCBrowser");
      fontLoaded();
    } else {
      WebFont.load({
        custom: {
          families: ['Oswald-Regular']
        },
        loading: function () {  //所有字体开始加载
          // console.log('loading');
        },
        active: function () {  //所有字体已渲染
          fontLoaded();
        },
        inactive: function () { //字体预加载失败，无效字体或浏览器不支持加载
          console.log('inactive: timeout');
          fontLoaded();
        },
        timeout: 5000 // Set the timeout to two seconds
      });
    }
  }

  function asyncErr(){
    console.warn('script load from CDN failed, will load local script')
  }

  // load webfont-loader async, and add callback function
  function async(u, cb, err) {
    var d = document, t = 'script',
      o = d.createElement(t),
      s = d.getElementsByTagName(t)[0];
    o.src = u;
    if (cb) { o.addEventListener('load', function (e) { cb(null, e); }, false); }
    if (err) { o.addEventListener('error', function (e) { err(null, e); }, false); }
    s.parentNode.insertBefore(o, s);
  }

  var asyncLoadWithFallBack = function(arr, success, reject) {
      var currReject = function(){
        reject()
        arr.shift()
        if(arr.length)
          async(arr[0], success, currReject)
        }

      async(arr[0], success, currReject)
  }

  asyncLoadWithFallBack([
    "https://cdn.jsdelivr.net/npm/webfontloader@1.6.28/webfontloader.min.js", 
    "https://cdn.bootcss.com/webfont/1.6.28/webfontloader.js",
    "/lib/webfontloader.min.js"
  ], asyncCb, asyncErr)
</script>        
        <img class="loading" src="/assets/loading.svg" style="display: block; margin: 6rem auto 0 auto; width: 6rem; height: 6rem;" />
        <div class="container container-unloaded">
            <main class="main post-page">
    <article class="article-entry">
        <a id="more"></a>
<h1 id="Android-Goldfish"><a href="#Android-Goldfish" class="headerlink" title="Android - Goldfish"></a>Android - Goldfish</h1><h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p><img src="//cufmheart.github.io/post/Android-Goldfish/goldfish_icon.png" alt="goldfish_icon"></p>
<p><strong>Goldfish</strong> 是一款具有 <strong>互动交友</strong>、<strong>视频 Feeds</strong> 功能的广播式社交 APP。</p>
<h2 id="开发环境"><a href="#开发环境" class="headerlink" title="开发环境"></a>开发环境</h2><ul>
<li><strong>操作系统</strong>：MacOS、Windows</li>
<li><strong>IDE</strong>：Android Studio、GoLand</li>
</ul>
<h2 id="功能信息"><a href="#功能信息" class="headerlink" title="功能信息"></a>功能信息</h2><ul>
<li>用户登录、用户注册、用户退出登录</li>
<li>基于关注机制、发现机制实现短视频信息的分享<ul>
<li>用户关注、用户取消关注</li>
<li>发布短视频，可设定<strong>私密</strong>、<strong>仅关注可见</strong>、<strong>公开可见</strong>三种权限</li>
</ul>
</li>
<li>用户界面：设置底部导航栏<ul>
<li><strong>主页</strong>：多页面 tab，可分别显示<strong>关注线</strong>、<strong>私密线</strong>的短视频 Feed 流</li>
<li><strong>发现</strong>：视频广场，显示自身权限可见的所有短视频 Feed 流</li>
<li><strong>消息</strong>：多页面 tab，显示动态和私信<ul>
<li>动态包括赞、评论、关注</li>
</ul>
</li>
<li><strong>我</strong>：个人信息<ul>
<li>用户名、关注数、粉丝数、视频数、获赞数</li>
<li>点击“关注数/粉丝数”跳转到该用户的<strong>关注列表</strong>和<strong>粉丝列表</strong></li>
<li>跳转个人主页、about 页、settings 页</li>
<li>退出登录</li>
</ul>
</li>
<li><strong>添加按钮</strong>：为浮动按钮，点击可以发布视频</li>
</ul>
</li>
<li>个人主页：显示用户的<strong>个人信息</strong>和自身权限可见的所有<strong>短视频 Feed</strong> 流<ul>
<li>进入方法：点击用户头像、用户名进入，通过“我”页面进入</li>
<li>底部菜单：“<strong>关注/取消关注</strong>”、“私信”，如果是自身则隐藏</li>
<li>点击“关注数/粉丝数”跳转到该用户的<strong>关注列表</strong>和<strong>粉丝列表</strong><ul>
<li>显示简单的用户信息，并提供“关注/取关”功能</li>
</ul>
</li>
</ul>
</li>
<li>视频发布页：包括调用摄像头、视频预览、权限选择、“取消/发送”等功能</li>
<li>短视频 Feed 流<ul>
<li>显示用户信息、发布时间</li>
<li>截取并显示视频预览图</li>
<li>显示短视频的评论数和获赞数</li>
</ul>
</li>
<li>视频详情页面<ul>
<li><strong>视频界面</strong>：加载、滚动显示视频，调用视频控制器</li>
<li>视频信息：用户信息、发布时间、评论数、获赞数</li>
<li><strong>评论</strong>：显示评论列表，每项包括用户信息、评论时间、评论内容</li>
<li><strong>评论框</strong>：输入评论并发送</li>
</ul>
</li>
</ul>
<h2 id="使用说明"><a href="#使用说明" class="headerlink" title="使用说明"></a>使用说明</h2><h3 id="应用部署"><a href="#应用部署" class="headerlink" title="应用部署"></a>应用部署</h3><h4 id="服务端部署"><a href="#服务端部署" class="headerlink" title="服务端部署"></a>服务端部署</h4><p>具体的服务配置位于 <code>Server/cmd/server/config.toml</code> 文件中，可自定义配置。由于服务依赖于 MySQL、Redis、FS 的运行，因此我们需要提前启动这些依赖服务。当前，我们已将这些依赖服务运行在外网环境。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 进入 Server/ 目录</span></span><br><span class="line"><span class="built_in">cd</span> Server/</span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动 go-fastdfs 对象存储服务</span></span><br><span class="line"><span class="built_in">cd</span> fs/</span><br><span class="line">docker-compose up -d</span><br><span class="line"></span><br><span class="line"><span class="comment"># 执行编译</span></span><br><span class="line">sh ./scripts.sh build</span><br><span class="line"></span><br><span class="line"><span class="comment"># 运行服务，请确保各项依赖服务均已正常运行</span></span><br><span class="line">sh ./scripts.sh run</span><br><span class="line"></span><br><span class="line"><span class="comment"># 停止服务</span></span><br><span class="line">sh ./scripts.sh stop</span><br></pre></td></tr></table></figure>
<h4 id="客户端使用"><a href="#客户端使用" class="headerlink" title="客户端使用"></a>客户端使用</h4><p>使用 Android Studio 即可。</p>
<h3 id="应用截图"><a href="#应用截图" class="headerlink" title="应用截图"></a>应用截图</h3><div class="table-container">
<table>
<thead>
<tr>
<th>登录页</th>
<th>注册页</th>
</tr>
</thead>
<tbody>
<tr>
<td><img src="//cufmheart.github.io/post/Android-Goldfish/image-20200716161438011.png" alt="image-20200716161438011"></td>
<td><img src="//cufmheart.github.io/post/Android-Goldfish/image-20200716161457136.png" alt="image-20200716161457136"></td>
</tr>
<tr>
<td>关注页</td>
<td>我的页</td>
</tr>
<tr>
<td><img src="//cufmheart.github.io/post/Android-Goldfish/image-20200716161545339.png" alt="image-20200716161545339"></td>
<td><img src="//cufmheart.github.io/post/Android-Goldfish/image-20200716161557264.png" alt="image-20200716161557264"></td>
</tr>
<tr>
<td>发现页</td>
<td>动态页</td>
</tr>
<tr>
<td><img src="//cufmheart.github.io/post/Android-Goldfish/image-20200716161610263.png" alt="image-20200716161610263"></td>
<td><img src="//cufmheart.github.io/post/Android-Goldfish/image-20200716161617457.png" alt="image-20200716161617457"></td>
</tr>
<tr>
<td>个人页</td>
<td>个人主页</td>
</tr>
<tr>
<td><img src="//cufmheart.github.io/post/Android-Goldfish/image-20200716161627515.png" alt="image-20200716161627515"></td>
<td><img src="//cufmheart.github.io/post/Android-Goldfish/image-20200716161637384.png" alt="image-20200716161637384"></td>
</tr>
<tr>
<td>粉丝页</td>
<td>订阅页</td>
</tr>
<tr>
<td><img src="//cufmheart.github.io/post/Android-Goldfish/image-20200716161650044.png" alt="image-20200716161650044"></td>
<td><img src="//cufmheart.github.io/post/Android-Goldfish/image-20200716161701810.png" alt="image-20200716161701810"></td>
</tr>
<tr>
<td>视频页（视频播放）</td>
<td>视频页（视频收起）</td>
</tr>
<tr>
<td><img src="//cufmheart.github.io/post/Android-Goldfish/image-20200716161726363.png" alt="image-20200716161726363"></td>
<td><img src="//cufmheart.github.io/post/Android-Goldfish/image-20200716161737216.png" alt="image-20200716161737216"></td>
</tr>
<tr>
<td>其他用户的个人主页</td>
<td>视频上传页</td>
</tr>
<tr>
<td><img src="//cufmheart.github.io/post/Android-Goldfish/image-20200716161833803.png" alt="image-20200716161833803"></td>
<td><img src="//cufmheart.github.io/post/Android-Goldfish/image-20200716161854135.png" alt="image-20200716161854135"></td>
</tr>
</tbody>
</table>
</div>
<h2 id="重点-amp-难点"><a href="#重点-amp-难点" class="headerlink" title="重点&amp;难点"></a>重点&amp;难点</h2><h3 id="用户关系服务"><a href="#用户关系服务" class="headerlink" title="用户关系服务"></a>用户关系服务</h3><p>在项目中，为了提供用户关注、用户取消关注的服务，我们需要选择合适的数据库来实现<strong>用户关系服务</strong>。参考新浪微博在用户社交关系的实践，我们使用 <code>Redis</code> 存储用户关系。通过维护 <code>user_id:follow</code> 和 <code>user_id:follower</code> 两个集合，我们可实现用户关注关系的维护。假设用户 A 关注了用户 B ，那么有以下过程：</p>
<ul>
<li>集合 <code>A:follow</code> 添加了 <code>B</code> 成员</li>
<li>同时，集合 <code>B:follower</code> 添加了 <code>A</code> 成员</li>
</ul>
<h3 id="读扩散与写扩散"><a href="#读扩散与写扩散" class="headerlink" title="读扩散与写扩散"></a>读扩散与写扩散</h3><p>在 Feed 列表的设计中，存在两种设计方法：<strong>读扩散</strong>、<strong>写扩散</strong>。</p>
<ul>
<li><strong>读扩散</strong>：每发布一条 Feed ，只落地一条记录，各个用户读取 Feed 列表时，需进行扩散读操作。</li>
<li><strong>写扩散</strong>：每发布一条 Feed ，将该 Feed 落地到每个用户（扩散写），用户读取 Feed 列表时，直接读取各自的 Feed 列表即可。</li>
</ul>
<p>在当前实现中，我们使用<strong>读扩散</strong>的设计，因为使用<strong>写扩散</strong>设计，需要复杂的写入逻辑，而且还需要考虑到新关注对象如何获取之前的 Feed 列表的问题，业务层需进行<strong>补偿</strong>操作。</p>
<h2 id="实现方法"><a href="#实现方法" class="headerlink" title="实现方法"></a>实现方法</h2><h3 id="客户端"><a href="#客户端" class="headerlink" title="客户端"></a>客户端</h3><h4 id="技术选型"><a href="#技术选型" class="headerlink" title="技术选型"></a>技术选型</h4><ol>
<li>语言：<code>Kotlin</code></li>
<li>架构：<code>MVVM</code>，利用 Android DataBinding 实现绑定</li>
<li>第三方库<ol>
<li><code>Glide</code> 用于实现网络图片加载</li>
<li><code>UniversalVideoView</code>: 用于实现网络视频播放</li>
<li><code>OkHttp3</code>: 用于提供易用的 Http 客户端实现</li>
<li><code>Retrofit2</code>: 用于提供简洁的 <code>HTTP</code> 接口</li>
<li><code>Rxjava</code>: 和 <code>Retrofit2</code> 结合，用于网络请求的异步处理</li>
<li><code>Gson</code>: 与 <code>Retrofit</code> 结合，用于解析 JSON 数据</li>
</ol>
</li>
</ol>
<h4 id="源代码文件结构"><a href="#源代码文件结构" class="headerlink" title="源代码文件结构"></a>源代码文件结构</h4><p>其中：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">data.datasource -- 数据源</span><br><span class="line">data.model -- 一些 Http 请求结果的封装</span><br><span class="line">data.repository -- 存储数据的类，ViewModel 与这里的类进行交互</span><br><span class="line">data.service -- 访问 HTTP 服务的类，其中包括 Http 接口调用和接口格式</span><br><span class="line"></span><br><span class="line">ui.feed -- Feed 流相</span><br><span class="line">ui.follow -- 关注与粉丝页面</span><br><span class="line">ui.homepage -- 个人页</span><br><span class="line">ui.main -- 主页面，包括发现、消息、动态、关注、个人页</span><br><span class="line">ui.user -- 用户登录注册代码</span><br><span class="line">ui.util -- UI 帮助类</span><br><span class="line">ui.video -- 视频详情页代码</span><br></pre></td></tr></table></figure>
<p><code>data</code> 包类结构：</p>
<p><img src="//cufmheart.github.io/post/Android-Goldfish/class_directory1.png" alt="class_directory"></p>
<p><code>ui</code> 包类结构</p>
<p><img src="//cufmheart.github.io/post/Android-Goldfish/class_directory2.png" alt="class_directory"></p>
<h4 id="MVVM-模式"><a href="#MVVM-模式" class="headerlink" title="MVVM 模式"></a>MVVM 模式</h4><ol>
<li>每个 Activity 负责加载布局文件，并将组件数据与 ViewModel 进行数据绑定（通过 LiveData），即 Activity 作为 View 存在</li>
<li>ViewModel 提供方法给 View，访问 Model 获取和更新数据</li>
<li>Model 负责与后端交互</li>
<li>数据流如下所示</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Activity/Layout &lt;--(DataBinding)--&gt; ViewModel &lt;----&gt; Model &lt;--(Retrofit/OkHttp)--&gt; Server</span><br></pre></td></tr></table></figure>
<p><img src="//cufmheart.github.io/post/Android-Goldfish/data_flow.png" alt="data_flow"></p>
<h4 id="DataBinding"><a href="#DataBinding" class="headerlink" title="DataBinding"></a>DataBinding</h4><p>Android DataBinding 库允许我们在布局文件中描述属性与 ViewModel 的绑定关系，比如 VideoActivity 展示视频信息的部分代码如下：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">layout</span> <span class="attr">xmlns:android</span>=<span class="string">"http://schemas.android.com/apk/res/android"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:app</span>=<span class="string">"http://schemas.android.com/apk/res-auto"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:tools</span>=<span class="string">"http://schemas.android.com/tools"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">data</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">variable</span></span></span><br><span class="line"><span class="tag">            <span class="attr">name</span>=<span class="string">"viewModel"</span></span></span><br><span class="line"><span class="tag">            <span class="attr">type</span>=<span class="string">"com.gitee.jiahonzheng.mad2020.ui.video.VideoViewModel"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">data</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    ....</span><br><span class="line">                <span class="tag">&lt;<span class="name">TextView</span></span></span><br><span class="line"><span class="tag">                    <span class="attr">android:id</span>=<span class="string">"@+id/card_video_username"</span></span></span><br><span class="line"><span class="tag">                    <span class="attr">android:layout_width</span>=<span class="string">"wrap_content"</span></span></span><br><span class="line"><span class="tag">                    <span class="attr">android:layout_height</span>=<span class="string">"wrap_content"</span></span></span><br><span class="line"><span class="tag">                    <span class="attr">android:layout_marginLeft</span>=<span class="string">"90dp"</span></span></span><br><span class="line"><span class="tag">                    <span class="attr">android:layout_marginTop</span>=<span class="string">"18dp"</span></span></span><br><span class="line"><span class="tag">                    <span class="attr">android:text</span>=<span class="string">"@&#123;viewModel.username&#125;"</span></span></span><br><span class="line"><span class="tag">                    <span class="attr">android:textColor</span>=<span class="string">"@color/colorGreyLightLight"</span></span></span><br><span class="line"><span class="tag">                    <span class="attr">android:textStyle</span>=<span class="string">"bold"</span></span></span><br><span class="line"><span class="tag">                    <span class="attr">android:textSize</span>=<span class="string">"18sp"</span> /&gt;</span></span><br><span class="line">    ....</span><br><span class="line">    </span><br><span class="line"><span class="tag">&lt;/<span class="name">layout</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>可以看到 <code>android:text</code> 属性已经绑定上 <code>ViewModel.username</code> 属性，该属性类型为 <code>LiveData&lt;String&gt;</code>，这样我们就可以实现页面数据与 ViewModel 的绑定。</p>
<p>对于绑定事件，我们也可以直接利用 <code>dataBinding</code> 对象直接获取组件来修改属性，而不必自己写 findViewById：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> viewModel = ViewModelProvider(<span class="keyword">this</span>).<span class="keyword">get</span>&lt;VideoViewModel&gt;()</span><br><span class="line">dataBinding = DataBindingUtil.setContentView(<span class="keyword">this</span>, R.layout.activity_video)</span><br><span class="line">dataBinding.viewModel = viewModel</span><br><span class="line">dataBinding.lifecycleOwner = <span class="keyword">this</span></span><br><span class="line"></span><br><span class="line">dataBinding.send.setOnClickListener &#123;</span><br><span class="line">    <span class="keyword">val</span> viewModel = ViewModelProvider(<span class="keyword">this</span>).<span class="keyword">get</span>&lt;VideoViewModel&gt;()</span><br><span class="line">    viewModel.sendComment()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">dataBinding.digg.setOnClickListener &#123;</span><br><span class="line">    <span class="keyword">val</span> viewModel = ViewModelProvider(<span class="keyword">this</span>).<span class="keyword">get</span>&lt;VideoViewModel&gt;()</span><br><span class="line">    viewModel.digg()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="事件驱动"><a href="#事件驱动" class="headerlink" title="事件驱动"></a>事件驱动</h4><p>上文中我们提到 MVVM 是基于数据绑定的，ViewModel 与 VIew 通过双向的数据绑定实现数据流的连接，从而实现 ViewModel 与 View 的解耦。</p>
<p>ViewModel 与 View 的绑定，是通过属性变化的事件通知实现的。比如调用了 <code>LiveData&lt;A&gt;</code> 的 set 方法，或者 <code>ObservableList&lt;T&gt;</code> 的任意更改函数，都会触发更新事件，通知相关事件订阅方实现数据的更新。</p>
<h4 id="头像"><a href="#头像" class="headerlink" title="头像"></a>头像</h4><p>头像的显示采用 Glide 实现：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Glide.with(context)</span><br><span class="line">    .load(item.avatar)</span><br><span class="line">    .centerCrop()</span><br><span class="line">    .dontAnimate()</span><br><span class="line">    .placeholder(R.drawable.avatar1)</span><br><span class="line">    .diskCacheStrategy(DiskCacheStrategy.ALL)</span><br><span class="line">    .into(binding.avatar)</span><br></pre></td></tr></table></figure>
<p>圆形的头像利用了第三方库 CircleImageView 实现：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">de.hdodenhof.circleimageview.CircleImageView</span></span></span><br><span class="line"><span class="tag">                                              <span class="attr">app:civ_border_color</span>=<span class="string">"@color/colorPrimary"</span></span></span><br><span class="line"><span class="tag">                                              <span class="attr">android:id</span>=<span class="string">"@+id/homepage_avatar"</span></span></span><br><span class="line"><span class="tag">                                              <span class="attr">android:layout_width</span>=<span class="string">"100dp"</span></span></span><br><span class="line"><span class="tag">                                              <span class="attr">android:layout_height</span>=<span class="string">"100dp"</span></span></span><br><span class="line"><span class="tag">                                              <span class="attr">android:layout_gravity</span>=<span class="string">"start"</span></span></span><br><span class="line"><span class="tag">                                              <span class="attr">android:layout_marginStart</span>=<span class="string">"15dp"</span></span></span><br><span class="line"><span class="tag">                                              <span class="attr">android:layout_marginTop</span>=<span class="string">"75dp"</span></span></span><br><span class="line"><span class="tag">                                              <span class="attr">android:src</span>=<span class="string">"@drawable/avatar1"</span></span></span><br><span class="line"><span class="tag">                                              <span class="attr">tools:ignore</span>=<span class="string">"MissingConstraints"</span> /&gt;</span></span><br></pre></td></tr></table></figure>
<h4 id="Feed-流"><a href="#Feed-流" class="headerlink" title="Feed 流"></a>Feed 流</h4><p>从技术角度来说，Feed 流、评论、消息等列表实现都是同类的，设计了 RecyclerFragment 基类来表示所有允许下拉刷新、滚动到底部继续加载数据的组件。</p>
<ol>
<li><code>ObservableArrayList</code> 允许监听列表项的变化，一旦有数据变化，通过事件监听，可以很方便地更新 UI 组件</li>
<li><code>EndlessRecyclerViewAdapter</code> 实现可以无限滚动的 RecyclerViewAdapter<ol>
<li>允许一般列表项时，还需要在尾部添加 LoadingView，即列表项类型不止一种</li>
<li>EndlessRecyclerViewAdapter 需要依赖其他 RecyclerViewAdapter 实现功能</li>
</ol>
</li>
<li><code>SwipeRefreshLayout</code>：允许用户可以刷新列表</li>
<li><code>RecyclerViewAdapter</code> 真正的 RecyclerView 视图控制逻辑，这里需要维护每个项的状态。因为 RecyclerView 会回收 ViewHolder，因此在 onBindViewHolder 时需要将数据加载到 ViewHolder 里。数据也算是 RecyclerView 的 ViewModel，绑定外部 ViewModel 提供的数据，最终是由 Model 提供。</li>
</ol>
<p>对于评论流，如果用户在某个评论发送了一个评论，那么 ViewModel 将向 Model 请求添加评论，Model 将评论通知给 VideoActivity 的 ViewModel 更新评论（通过 ObservableList），以及 Feed 流的评论数。评论向下滚动时会出现加载中的标识，EndlessRecyclerViewAdapter 会要求获取数据，ViewModel 向 Model 获取数据后返回有效数据。</p>
<h4 id="视频播放页"><a href="#视频播放页" class="headerlink" title="视频播放页"></a>视频播放页</h4><p>VideoActivity 采用了 UniversalVideoView 来加载、显示视频、采用 UniversalMediaController 来控制视频播放。此外采用了 CollapsingToolbarLayout 来实现视频可以滚动的效果。</p>
<p>采用 CardView 和 DataBinding 来显示视频信息，包括用户信息、发布时间、评论数、获赞数。</p>
<p>设计了 VideoCommentFragment 和 CommentRecyclerViewAdapter 来显示评论列表，每项包括用户信息、评论时间、评论内容。下方通过对 “send” button 的事件监听来实现评论的发送。</p>
<h5 id="删除评论"><a href="#删除评论" class="headerlink" title="删除评论"></a>删除评论</h5><p>删除评论采用了 ContextMenu 弹出菜单，菜单中可以选择删除评论。其中 RecyclerView 没有实现 ContextMenu 的相关接口，因此需要自己实现一个 RecyclerView 的子类，并完成 showContextMenu 相关函数的实现：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ContextMenuRecyclerView</span> : <span class="type">RecyclerView &#123;</span></span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">var</span> contextMenuInfo: AdapterContextMenuInfo? = <span class="literal">null</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">getContextMenuInfo</span><span class="params">()</span></span>: AdapterContextMenuInfo? &#123;</span><br><span class="line">        <span class="keyword">return</span> contextMenuInfo</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">showContextMenuForChild</span><span class="params">(originalView: <span class="type">View</span>)</span></span>: <span class="built_in">Boolean</span> &#123;</span><br><span class="line">        <span class="keyword">val</span> position = getChildAdapterPosition(originalView)</span><br><span class="line">        <span class="keyword">val</span> longId = getChildItemId(originalView)</span><br><span class="line">        contextMenuInfo = AdapterContextMenuInfo(originalView, position, longId)</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">super</span>.showContextMenuForChild(originalView)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>接下来就可以在 Fragment 中实现 onContextItemSelected 函数来达到删除评论的目的。</p>
<h4 id="登录注册页"><a href="#登录注册页" class="headerlink" title="登录注册页"></a>登录注册页</h4><p>实现了自动登录，登录页的用户名会保存在 SharedPreferences 中，避免下次登录时还要重新输入账号的麻烦。</p>
<p>此外，如果 Model 有任意一次网络请求后台返回了 “201 Unauthorized”，即未登录，客户端也会自动弹出登录页要求登录。即从任意页面都会进入登录页。此外个人页面的“退出登录”按钮也会返回到登录页。</p>
<p>如果没有保存的账号，那么登录页再跳转到注册页，注册页和登录页可以互相跳转。</p>
<h4 id="主页面"><a href="#主页面" class="headerlink" title="主页面"></a>主页面</h4><p>主页面采用了 BottomNavigationView 来实现页面的跳转，BottomNavigationView/TabLayout 和 ViewPager 结合可以实现页面的跳转。</p>
<p>主页面使用了 FloatingActionButton 来显示发布视频的按钮。</p>
<p>主页面设置了顶部的 tab 栏，可分别显示<strong>关注线</strong>、<strong>私密线</strong>的短视频 Feed 流，根据服务端接口实现。关注线只展示自身所关注的用户所发布的非私密视频，私密线展示自身发布的所有视频。</p>
<p>部分代码如下：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onViewCreated</span><span class="params">(view: <span class="type">View</span>, savedInstanceState: <span class="type">Bundle</span>?)</span></span> &#123;</span><br><span class="line">        <span class="keyword">super</span>.onViewCreated(view, savedInstanceState)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">val</span> viewPager = view.findViewById&lt;ViewPager&gt;(R.id.view_pager)</span><br><span class="line">        <span class="keyword">val</span> tabLayout = view.findViewById&lt;TabLayout&gt;(R.id.tab_layout)</span><br><span class="line">        tabLayout.setupWithViewPager(viewPager)</span><br><span class="line">        viewPager.adapter = <span class="keyword">object</span> : FragmentStatePagerAdapter(childFragmentManager, BEHAVIOR_RESUME_ONLY_CURRENT_FRAGMENT) &#123;</span><br><span class="line">            <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">getCount</span><span class="params">()</span></span>: <span class="built_in">Int</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="number">2</span></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">getPageTitle</span><span class="params">(position: <span class="type">Int</span>)</span></span>: CharSequence? &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">when</span> (position) &#123;</span><br><span class="line">                    <span class="number">0</span> -&gt; view.context.getString(R.string.home_tab_1)</span><br><span class="line">                    <span class="number">1</span> -&gt; view.context.getString(R.string.home_tab_2)</span><br><span class="line">                    <span class="keyword">else</span> -&gt; <span class="keyword">throw</span> IllegalStateException(<span class="string">"Overflow position <span class="variable">$position</span>"</span>)</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">getItem</span><span class="params">(position: <span class="type">Int</span>)</span></span>: Fragment &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">when</span> (position) &#123;</span><br><span class="line">                    <span class="number">0</span> -&gt; HomeFollowFragment()</span><br><span class="line">                    <span class="number">1</span> -&gt; HomeMeFragment()</span><br><span class="line">                    <span class="keyword">else</span> -&gt; <span class="keyword">throw</span> IllegalStateException(<span class="string">"Overflow position <span class="variable">$position</span>"</span>)</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h4 id="发现页"><a href="#发现页" class="headerlink" title="发现页"></a>发现页</h4><p>设计为短视频广场，用于发现显示公开的 Feed 流信息。顶部是一个搜索栏，主体是通过 RecyclerFragment 完成的短视频列表，与主页面类似。在这里，显示所有自身可见的视频。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FindFragment</span> : <span class="type">FeedListFragment</span></span>() &#123;</span><br><span class="line">    <span class="keyword">override</span> <span class="keyword">val</span> layoutId: <span class="built_in">Int</span></span><br><span class="line">        <span class="keyword">get</span>() = R.layout.fragment_find</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">fetchData</span><span class="params">()</span></span> =</span><br><span class="line">        Services.videoService.getFeedPublic(</span><br><span class="line">            AuthInterceptor.bearer,</span><br><span class="line">            nextItem</span><br><span class="line">        ).throwIfError().map &#123; it.next to it.feed &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="消息页"><a href="#消息页" class="headerlink" title="消息页"></a>消息页</h4><p>同样使用了 ViewPager 来实现页面的跳转，顶部 tab 栏分别显示动态和私信（尚未实现），动态包括来自其他用户的赞、评论、关注。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">viewPager.adapter = <span class="keyword">object</span> : FragmentStatePagerAdapter(childFragmentManager, BEHAVIOR_RESUME_ONLY_CURRENT_FRAGMENT) &#123;</span><br><span class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">getCount</span><span class="params">()</span></span>: <span class="built_in">Int</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">2</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">getPageTitle</span><span class="params">(position: <span class="type">Int</span>)</span></span>: CharSequence? &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">when</span> (position) &#123;</span><br><span class="line">      <span class="number">0</span> -&gt; view.context.getString(R.string.message_tab_1)</span><br><span class="line">      <span class="number">1</span> -&gt; view.context.getString(R.string.message_tab_2)</span><br><span class="line">      <span class="keyword">else</span> -&gt; <span class="keyword">throw</span> IllegalStateException(<span class="string">"Overflow position <span class="variable">$position</span>"</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">getItem</span><span class="params">(position: <span class="type">Int</span>)</span></span>: Fragment &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">when</span> (position) &#123;</span><br><span class="line">      <span class="number">0</span> -&gt; MessageActivityFragment()</span><br><span class="line">      <span class="number">1</span> -&gt; Fragment()</span><br><span class="line">      <span class="keyword">else</span> -&gt; <span class="keyword">throw</span> IllegalStateException(<span class="string">"Overflow position <span class="variable">$position</span>"</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="用户页"><a href="#用户页" class="headerlink" title="用户页"></a>用户页</h4><p>“我”页面通过 CardView 和 DataBinding 来显示自身的用户信息，包括“用户名、头像、关注数、粉丝数、视频数、获赞数”等，并提供 6 个页面跳转的监听函数，可跳转个人主页、about 页、settings 页、注册登录页、粉丝列表页、关注列表页，代码如下：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">binding.meBtnSignout.setOnClickListener &#123;</span><br><span class="line">  viewModel.logout()</span><br><span class="line">  startActivity(Intent(context, LoginActivity::<span class="class"><span class="keyword">class</span>.<span class="title">java</span>))</span></span><br><span class="line">&#125;</span><br><span class="line">binding.meBtnHomepage.setOnClickListener &#123;</span><br><span class="line">  startActivity(Intent(context, HomepageActivity::<span class="class"><span class="keyword">class</span>.<span class="title">java</span>)</span></span><br><span class="line">  .putExtra(<span class="string">"userId"</span>, Goldfish.instance.userRepository.user.value?.userId ?: <span class="string">""</span>))</span><br><span class="line">&#125;</span><br><span class="line">binding.cardMeSetting.setOnClickListener &#123;</span><br><span class="line">  startActivity(Intent(context, SettingsActivity::<span class="class"><span class="keyword">class</span>.<span class="title">java</span>))</span></span><br><span class="line">&#125;</span><br><span class="line">binding.meBtnAbout.setOnClickListener &#123;</span><br><span class="line">	startActivity(Intent(context, AboutActivity::<span class="class"><span class="keyword">class</span>.<span class="title">java</span>))</span></span><br><span class="line">&#125;</span><br><span class="line">binding.textFollowers.setOnClickListener &#123;</span><br><span class="line">	startActivity(Intent(context, FollowersActivity::<span class="class"><span class="keyword">class</span>.<span class="title">java</span>)</span></span><br><span class="line">	.putExtra(<span class="string">"userId"</span>, Goldfish.instance.userRepository.user.value?.userId ?: <span class="string">""</span>))</span><br><span class="line">&#125;</span><br><span class="line">binding.textFollows.setOnClickListener &#123;</span><br><span class="line">	startActivity(Intent(context, FollowsActivity::<span class="class"><span class="keyword">class</span>.<span class="title">java</span>)</span></span><br><span class="line">	.putExtra(<span class="string">"userId"</span>, Goldfish.instance.userRepository.user.value?.userId ?: <span class="string">""</span>))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="个人主页"><a href="#个人主页" class="headerlink" title="个人主页"></a>个人主页</h4><p>个人主页用于显示用户的<strong>个人信息</strong>和自身权限可见的所有<strong>短视频 Feed</strong>，可以通过点击用户头像或用户名、用户页等方式进入。</p>
<p>个人主页使用 CollapsingToolbarLayout 来实现用户信息的滑动缩放显示，使用 bottom menu 来实现底部菜单，包括 “<strong>关注/取消关注</strong>”、“私信” 两个选项，在  HomepageActivity 的 onCreate() 中判断访问的是否是自身的个人主页，如果是则在 initBottomMenu() 中选择直接返回。在个人主页中点击 “关注数/粉丝数” 也可以跳转到该用户的<strong>关注列表</strong>和<strong>粉丝列表</strong>，并显示简单的用户信息，提供“关注/取关”功能。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Goldfish.instance.userRepository.user.value?.userId?.let &#123;</span><br><span class="line">  isMe = it == userId</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>个人主页通过订阅视频的变化来获取更新通知。比如用户给个人主页内的视频点赞，那么点赞操作将产生事件。个人主页 ViewModel 只需要监听点赞操作或者评论列表变化事件后就可以更新个人主页内用户的点赞数、评论数。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">ViewModel.onCreate:</span><br><span class="line">    Goldfish.instance.videoRepository.getPeopleByUserId(userId)</span><br><span class="line">		.addOnListChangedCallback(listener)</span><br><span class="line">ViewModel.onDestroy:</span><br><span class="line">    Goldfish.instance.videoRepository.getPeopleByUserId(userId)</span><br><span class="line">		.removeOnListChangedCallback(listener)</span><br></pre></td></tr></table></figure>
<h4 id="视频发布页"><a href="#视频发布页" class="headerlink" title="视频发布页"></a>视频发布页</h4><p>点击发布视频的 FloatingActionButton 后，使用以下代码来调用摄像头：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">addButton.setOnClickListener &#123;</span><br><span class="line">	Intent(MediaStore.ACTION_VIDEO_CAPTURE).also &#123; takeVideoIntent -&gt;</span><br><span class="line">		takeVideoIntent.resolveActivity(packageManager)?.also &#123;</span><br><span class="line">			startActivityForResult(takeVideoIntent, REQUEST_VIDEO_CAPTURE)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>并检查 REQUEST_VIDEO_CAPTURE：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onActivityResult</span><span class="params">(requestCode: <span class="type">Int</span>, resultCode: <span class="type">Int</span>, intent: <span class="type">Intent</span>?)</span></span> &#123;</span><br><span class="line">	<span class="keyword">super</span>.onActivityResult(requestCode, resultCode, intent)</span><br><span class="line">	<span class="keyword">if</span> (requestCode == REQUEST_VIDEO_CAPTURE &amp;&amp; resultCode == RESULT_OK) &#123;</span><br><span class="line">		intent?.<span class="keyword">data</span>?.also &#123; videoUri -&gt;</span><br><span class="line">			startActivity(</span><br><span class="line">				Intent(<span class="keyword">this</span>, UploadActivity::<span class="class"><span class="keyword">class</span>.<span class="title">java</span>)</span></span><br><span class="line">				.putExtra(<span class="string">"videoUri"</span>, videoUri)</span><br><span class="line">			)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后进入视频预览，使用 RadioGroup 实现权限选择功能、在顶部实现 “取消/发送” 等功能。</p>
<h3 id="服务端"><a href="#服务端" class="headerlink" title="服务端"></a>服务端</h3><h4 id="技术选型-1"><a href="#技术选型-1" class="headerlink" title="技术选型"></a>技术选型</h4><ol>
<li>语言：<code>Golang</code></li>
<li>数据库：<code>MySQL</code>、<code>Redis</code></li>
<li>对象存储：<a href="https://github.com/sjqzhang/go-fastdfs" target="_blank" rel="noopener"><code>go-fastdfs</code></a></li>
<li>第三方库：<ul>
<li><a href="github.com/gofiber/fiber"><code>fiber</code></a>：基于 <a href="https://github.com/valyala/fasthttp" target="_blank" rel="noopener"><code>fasthttp</code></a> 实现的高性能 Web 应用开发框架，使用方式与 <a href="https://expressjs.com/" target="_blank" rel="noopener"><code>Express</code></a> 相似。</li>
<li><a href="github.com/jinzhu/gorm"><code>gorm</code></a>：一款对开发者友好的 <code>ORM</code> 框架，且使用文档齐全，支持主流数据库。</li>
<li><a href="github.com/dgrijalva/jwt-go"><code>jwt-go</code></a>：<code>JWT</code> 验证中间件。</li>
<li><a href="github.com/go-redis/redis/v8"><code>redis</code></a>：<code>Redis</code> 数据库连接客户端。</li>
<li><a href="github.com/sony/sonyflake"><code>sonyflake</code></a>：分布式 ID 生成器，使用的算法基于 Twitter <code>Snowflake</code> 算法，是对其的优化版本。</li>
<li><a href="github.com/spf13/pflag"><code>pflag</code></a>：一款对开发者优化的命令行参数工具。</li>
<li><a href="github.com/spf13/viper"><code>viper</code></a>：配置读取工具，支持本地、远程的服务配置读取，支持 <code>JSON</code>、<code>TOML</code>、<code>YAML</code> 等格式文件的读取。</li>
</ul>
</li>
</ol>
<h4 id="源代码文件结构-1"><a href="#源代码文件结构-1" class="headerlink" title="源代码文件结构"></a>源代码文件结构</h4><p>我们使用 <code>MVC</code> 架构完成服务端程序的设计，<code>model/</code> 目录存放各业务实体的具体定义，<code>service/</code> 目录存放业务逻辑的核心实现，<code>controller/</code> 目录存放控制器的实现，<code>cmd/</code> 目录存放主程序实现，<code>dto/</code> 目录存放各接口请求和响应的具体定义，<code>ecode/</code> 目录存放业务逻辑的错误码及其描述，<code>constant/</code> 目录存放常量定义，<code>util/</code> 目录存放工具函数。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">.</span><br><span class="line">├── cmd</span><br><span class="line">│   └── server</span><br><span class="line">│       ├── config.toml</span><br><span class="line">│       ├── main.go</span><br><span class="line">│       └── route.go</span><br><span class="line">├── constant</span><br><span class="line">│   └── constant.go</span><br><span class="line">├── controller</span><br><span class="line">│   ├── activity.go</span><br><span class="line">│   ├── controller.go</span><br><span class="line">│   ├── user.go</span><br><span class="line">│   └── video.go</span><br><span class="line">├── dto</span><br><span class="line">│   ├── activity.go</span><br><span class="line">│   ├── dto.go</span><br><span class="line">│   ├── user.go</span><br><span class="line">│   └── video.go</span><br><span class="line">├── ecode</span><br><span class="line">│   └── ecode.go</span><br><span class="line">├── model</span><br><span class="line">│   ├── activity.go</span><br><span class="line">│   ├── comment.go</span><br><span class="line">│   ├── user.go</span><br><span class="line">│   └── video.go</span><br><span class="line">├── service</span><br><span class="line">│   ├── activity</span><br><span class="line">│   │   └── activity.go</span><br><span class="line">│   ├── conf</span><br><span class="line">│   │   └── config.go</span><br><span class="line">│   ├── db</span><br><span class="line">│   │   ├── mysql.go</span><br><span class="line">│   │   └── redis.go</span><br><span class="line">│   ├── user</span><br><span class="line">│   │   └── user.go</span><br><span class="line">│   └── video</span><br><span class="line">│       └── video.go</span><br><span class="line">└── util</span><br><span class="line">    ├── conv.go</span><br><span class="line">    ├── idgen.go</span><br><span class="line">    ├── kv.go</span><br><span class="line">    └── log.go</span><br></pre></td></tr></table></figure>
<h4 id="数据库设计"><a href="#数据库设计" class="headerlink" title="数据库设计"></a>数据库设计</h4><p>在项目中，我们使用 <code>MySQL</code>、<code>Redis</code> 作为数据存储服务。其中，<code>MySQL</code> 主要由<strong>用户信息表</strong>、<strong>视频信息表</strong>、<strong>评论信息表</strong>、<strong>用户动态表</strong>组成，维护需要具备<strong>强一致性</strong>的业务数据；<code>Redis</code> 则用于维护用户关系（关注与被关注）与视频点赞的业务数据。</p>
<p>由于我们使用 <code>Snowflake</code> 算法作为 ID 生成策略，所以数据表中的 ID 字段我们都使用 <code>bigint</code> 类型。</p>
<ul>
<li><p>用户信息表</p>
<p>在该表中，我们维护了用户的各种“总数”数据，如已发布视频总数 <code>video</code> 、关注列表大小 <code>follow</code> 、粉丝列表大小 <code>follower</code> 、视频获赞总数 <code>digg</code> 。</p>
</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`user`</span> (</span><br><span class="line">  <span class="string">`id`</span> <span class="built_in">bigint</span>(<span class="number">20</span>) <span class="keyword">unsigned</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> AUTO_INCREMENT,</span><br><span class="line">  <span class="string">`user_id`</span> <span class="built_in">bigint</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'用户ID'</span>,</span><br><span class="line">  <span class="string">`username`</span> <span class="built_in">varchar</span>(<span class="number">255</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'用户名'</span>,</span><br><span class="line">  <span class="string">`avatar`</span> <span class="built_in">varchar</span>(<span class="number">255</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'用户头像链接'</span>,</span><br><span class="line">  <span class="string">`password`</span> <span class="built_in">varchar</span>(<span class="number">255</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'用户密码'</span>,</span><br><span class="line">  <span class="string">`create_time`</span> datetime <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'创建时间'</span>,</span><br><span class="line">  <span class="string">`video`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'发布视频总数'</span>,</span><br><span class="line">  <span class="string">`follow`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'关注列表大小'</span>,</span><br><span class="line">  <span class="string">`follower`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'粉丝列表大小'</span>,</span><br><span class="line">  <span class="string">`digg`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'获赞总数'</span>,</span><br><span class="line">  PRIMARY <span class="keyword">KEY</span> (<span class="string">`id`</span>),</span><br><span class="line">  <span class="keyword">UNIQUE</span> <span class="keyword">KEY</span> <span class="string">`uniq_user_id`</span> (<span class="string">`user_id`</span>) <span class="keyword">USING</span> BTREE,</span><br><span class="line">  <span class="keyword">UNIQUE</span> <span class="keyword">KEY</span> <span class="string">`uniq_username`</span> (<span class="string">`username`</span>) <span class="keyword">USING</span> BTREE</span><br><span class="line">) <span class="keyword">ENGINE</span> = <span class="keyword">InnoDB</span> <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span> = utf8mb4;</span><br></pre></td></tr></table></figure>
<ul>
<li><p>视频信息表</p>
<p>在该表中，我们维护了视频的“总数”数据，如点赞总数 <code>digg</code> 、评论总数 <code>comment</code> 。</p>
</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`video`</span> (</span><br><span class="line">  <span class="string">`id`</span> <span class="built_in">bigint</span>(<span class="number">20</span>) <span class="keyword">unsigned</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> AUTO_INCREMENT,</span><br><span class="line">  <span class="string">`video_id`</span> <span class="built_in">bigint</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'视频ID'</span>,</span><br><span class="line">  <span class="string">`owner_id`</span> <span class="built_in">bigint</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'发布者用户ID'</span>,</span><br><span class="line">  <span class="string">`url`</span> <span class="built_in">varchar</span>(<span class="number">255</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'存储地址'</span>,</span><br><span class="line">  <span class="string">`thumb_url`</span> <span class="built_in">varchar</span>(<span class="number">255</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'封面存储地址'</span>,</span><br><span class="line">  <span class="string">`status`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'视频状态：0为已上传，1为已删除'</span>,</span><br><span class="line">  <span class="string">`type`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'视频类型：0为私密，1为仅关注可见，2为公开可见'</span>,</span><br><span class="line">  <span class="string">`create_time`</span> datetime <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'创建时间'</span>,</span><br><span class="line">  <span class="string">`delete_time`</span> datetime <span class="keyword">COMMENT</span> <span class="string">'删除时间'</span>,</span><br><span class="line">  <span class="string">`digg`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'点赞总数'</span>,</span><br><span class="line">  <span class="string">`comment`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'评论总数'</span>,</span><br><span class="line">  PRIMARY <span class="keyword">KEY</span> (<span class="string">`id`</span>),</span><br><span class="line">  <span class="keyword">UNIQUE</span> <span class="keyword">KEY</span> <span class="string">`uniq_video_id`</span> (<span class="string">`video_id`</span>) <span class="keyword">USING</span> BTREE,</span><br><span class="line">  <span class="keyword">KEY</span> <span class="string">`idx_status_create_time_type_owner_id`</span> (<span class="string">`status`</span>, <span class="string">`create_time`</span>, <span class="string">`type`</span>, <span class="string">`owner_id`</span>) <span class="keyword">USING</span> BTREE,</span><br><span class="line">  <span class="keyword">KEY</span> <span class="string">`idx_owner_id_status_create_time_type`</span> (<span class="string">`owner_id`</span>, <span class="string">`status`</span>, <span class="string">`create_time`</span>, <span class="string">`type`</span>) <span class="keyword">USING</span> BTREE</span><br><span class="line">) <span class="keyword">ENGINE</span> = <span class="keyword">InnoDB</span> <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span> = utf8mb4;</span><br></pre></td></tr></table></figure>
<ul>
<li><p>评论信息表</p>
<p>在该表中，我们维护了每一个视频下的所有评论信息。</p>
</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`comment`</span> (</span><br><span class="line">  <span class="string">`id`</span> <span class="built_in">bigint</span>(<span class="number">20</span>) <span class="keyword">unsigned</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> AUTO_INCREMENT,</span><br><span class="line">  <span class="string">`comment_id`</span> <span class="built_in">bigint</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'评论ID'</span>,</span><br><span class="line">  <span class="string">`video_id`</span> <span class="built_in">bigint</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'评论视频ID'</span>,</span><br><span class="line">  <span class="string">`user_id`</span> <span class="built_in">bigint</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'评论者用户ID'</span>,</span><br><span class="line">  <span class="string">`content`</span> <span class="built_in">varchar</span>(<span class="number">255</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'评论内容'</span>,</span><br><span class="line">  <span class="string">`status`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'评论状态：0为默认，1为已删除'</span>,</span><br><span class="line">  <span class="string">`create_time`</span> datetime <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'创建时间'</span>,</span><br><span class="line">  <span class="string">`delete_time`</span> datetime <span class="keyword">COMMENT</span> <span class="string">'删除时间'</span>,</span><br><span class="line">  PRIMARY <span class="keyword">KEY</span> (<span class="string">`id`</span>),</span><br><span class="line">  <span class="keyword">UNIQUE</span> <span class="keyword">KEY</span> <span class="string">`uniq_comment_id`</span> (<span class="string">`comment_id`</span>) <span class="keyword">USING</span> BTREE,</span><br><span class="line">  <span class="keyword">KEY</span> <span class="string">`idx_video_id_status_create_time`</span> (<span class="string">`video_id`</span>, <span class="string">`status`</span>, <span class="string">`create_time`</span>) <span class="keyword">USING</span> BTREE</span><br><span class="line">) <span class="keyword">ENGINE</span> = <span class="keyword">InnoDB</span> <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span> = utf8mb4;</span><br></pre></td></tr></table></figure>
<ul>
<li><p>用户动态表</p>
<p>在当前项目中，我们希望当一个用户获得了新的关注时、其发布的视频获得了点赞或评论时，该用户可以在客户端上看到这些动态消息。于是，处于该目的，我们设计了用户动态表，其中的 <code>type</code> 表明当前动态消息由哪些操作（关注、点赞、评论）触发的。</p>
</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`activity`</span> (</span><br><span class="line">  <span class="string">`id`</span> <span class="built_in">bigint</span>(<span class="number">20</span>) <span class="keyword">unsigned</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> AUTO_INCREMENT,</span><br><span class="line">  <span class="string">`activity_id`</span> <span class="built_in">bigint</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'动态ID'</span>,</span><br><span class="line">  <span class="string">`user_id`</span> <span class="built_in">bigint</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'用户ID'</span>,</span><br><span class="line">  <span class="string">`type`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'动态类型：0为关注，1为点赞，2为评论'</span>,</span><br><span class="line">  <span class="string">`create_time`</span> datetime <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'创建时间'</span>,</span><br><span class="line">  <span class="string">`related_video_id`</span> <span class="built_in">bigint</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'相关视频ID'</span>,</span><br><span class="line">  <span class="string">`related_user_id`</span> <span class="built_in">bigint</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'相关用户ID'</span>,</span><br><span class="line">  PRIMARY <span class="keyword">KEY</span> (<span class="string">`id`</span>),</span><br><span class="line">  <span class="keyword">UNIQUE</span> <span class="keyword">KEY</span> <span class="string">`uniq_activity_id`</span> (<span class="string">`activity_id`</span>) <span class="keyword">USING</span> BTREE,</span><br><span class="line">  <span class="keyword">KEY</span> <span class="string">`idx_user_id_create_time`</span> (<span class="string">`user_id`</span>, <span class="string">`create_time`</span>) <span class="keyword">USING</span> BTREE</span><br><span class="line">) <span class="keyword">ENGINE</span> = <span class="keyword">InnoDB</span> <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span> = utf8mb4;</span><br></pre></td></tr></table></figure>
<h4 id="ID-生成策略"><a href="#ID-生成策略" class="headerlink" title="ID 生成策略"></a>ID 生成策略</h4><p>在项目实现中，我们使用 <code>Snowflake</code> 算法作为 ID 的生成策略。该算法源自 Twitter ，是一种分布式 ID 生成算法。在代码实现中，我们使用第三方库 <code>sony/sonyflake</code> 实现 ID 生成的操作，该库所使用的算法是对原始 <code>Snowflake</code> 算法的一种优化，其生成的 ID 可划分为以下 3 部分：</p>
<ul>
<li>39 bits for time in units of 10 msec</li>
<li>8 bits for a sequence number</li>
<li>16 bits for a machine id</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> util</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">"github.com/sony/sonyflake"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> sf *sonyflake.Sonyflake</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">init</span><span class="params">()</span></span> &#123;</span><br><span class="line">	sf = sonyflake.NewSonyflake(sonyflake.Settings&#123;&#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// NextID generates a next unique ID</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NextID</span><span class="params">()</span> <span class="params">(<span class="keyword">uint64</span>, error)</span></span> &#123;</span><br><span class="line">	<span class="keyword">return</span> sf.NextID()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="用户关系服务-1"><a href="#用户关系服务-1" class="headerlink" title="用户关系服务"></a>用户关系服务</h4><p>在用户关系服务的实现中，我们参考新浪微博在社交关系服务方面的实践，使用 <code>Redis</code> 作为用户关系的存储载体。我们可以通过维护 <code>user_id:follow</code> 和 <code>user_id:follower</code> 两个集合，即可实现用户关注与取消关注的服务。假设用户 A 关注了用户 B ，那么有以下过程：</p>
<ul>
<li>集合 <code>A:follow</code> 添加了 <code>B</code> 成员</li>
<li>同时，集合 <code>B:follower</code> 添加了 <code>A</code> 成员</li>
</ul>
<p>在 <code>Redis</code> 中，与集合相关的数据结构有两种，分别是 <code>set</code> 和 <code>zset</code> 。在项目实现中，我们选择了 <code>zset</code> ，因为相比于 <code>set</code> ，<code>zset</code> 提供了分页获取的命令 <code>zrange</code> 和 <code>zrevrange</code> ，这可以帮助我们实现关注列表和粉丝列表的分页获取接口。</p>
<h5 id="关注与取消关注"><a href="#关注与取消关注" class="headerlink" title="关注与取消关注"></a>关注与取消关注</h5><p>在实现中，关注服务的业务逻辑由 <code>Redis TxPipeline</code> 和 <code>MySQL Transaction</code> 两部份组成，前者维护具体的关注关系，后者维护关注列表与粉丝列表的大小。<code>Redis TxPipeline</code> 可以理解成 <code>Redis</code> 数据库下的事务实现，与 <code>MySQL Transaction</code> 不同的是，<strong>前者是不支持回滚操作的</strong>。因此，业务逻辑存在 <code>Redis</code> 事务提交，而 <code>MySQL</code> 事务失败，导致数据不一致的情况。事实上，用户关注这件事情本身对一致性要求不是太高，因此我们可以使用一种<strong>异步补偿</strong>的策略，即在 <code>MySQL</code> 事务回滚时，输出相应的日志，后续根据这些日志，在 <code>Redis</code> 中使用 <code>zcard</code> 命令获得总数，更新至 <code>MySQL</code> 中。</p>
<p>之所以，我们不直接使用 <code>zcard</code> 命令来获取总数，是因为关注请求数量相对于读请求的数量还是非常小的，因此在处理读请求时使用 <code>zcard</code> 命令（读扩散操作）带来的收益（数据一致性）并没有写扩散带来的收益（性能）明显。</p>
<p>PS: 在使用 <code>zset</code> 数据结构时，我们选择用户的关注操作时间作为 <code>score</code> 。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(u *User)</span> <span class="title">Follow</span><span class="params">(own <span class="keyword">int64</span>, other <span class="keyword">int64</span>)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">    ctx := context.Background()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Redis 事务</span></span><br><span class="line">	pipe := db.Redis.TxPipeline()</span><br><span class="line">	now := <span class="keyword">float64</span>(time.Now().Unix())</span><br><span class="line">	follow := pipe.ZAdd(ctx, util.GetUserFollowKey(own), &amp;redis.Z&#123;Score: now, Member: other&#125;)</span><br><span class="line">	follower := pipe.ZAdd(ctx, util.GetUserFollowerKey(other), &amp;redis.Z&#123;Score: now, Member: own&#125;)</span><br><span class="line">	<span class="keyword">if</span> _, err := pipe.Exec(ctx); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> err</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 判断是否可提前中断后续的 MySQL 事务</span></span><br><span class="line">	<span class="keyword">if</span> follow.Val() == <span class="number">0</span> &amp;&amp; follower.Val() == <span class="number">0</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">	&#125;</span><br><span class="line">    <span class="comment">// MySQL 事务</span></span><br><span class="line">	tx := db.MySQL.BeginTx(ctx, <span class="literal">nil</span>)</span><br><span class="line">	<span class="keyword">defer</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">		<span class="keyword">if</span> r := <span class="built_in">recover</span>(); r != <span class="literal">nil</span> &#123;</span><br><span class="line">			tx.Rollback()</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;()</span><br><span class="line">    <span class="comment">// 更新关注列表的总大小</span></span><br><span class="line">	<span class="keyword">if</span> follow.Val() == <span class="number">1</span> &#123;</span><br><span class="line">		<span class="keyword">if</span> err := tx.Exec(<span class="string">"UPDATE user SET follow = follow + 1 WHERE user_id = ?"</span>, own).Error; err != <span class="literal">nil</span> &#123;</span><br><span class="line">			tx.Rollback()</span><br><span class="line">			<span class="keyword">return</span> err</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">    <span class="comment">// 更新粉丝列表的总大小</span></span><br><span class="line">	<span class="keyword">if</span> follower.Val() == <span class="number">1</span> &#123;</span><br><span class="line">		<span class="keyword">if</span> err := tx.Exec(<span class="string">"UPDATE user SET follower = follower + 1 WHERE user_id = ?"</span>, other).Error; err != <span class="literal">nil</span> &#123;</span><br><span class="line">			tx.Rollback()</span><br><span class="line">			<span class="keyword">return</span> err</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> tx.Commit().Error</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="关注列表与粉丝列表"><a href="#关注列表与粉丝列表" class="headerlink" title="关注列表与粉丝列表"></a>关注列表与粉丝列表</h5><p>由于我们使用的是 <code>zset</code> 数据结构存储用户关注关系，因此我们可以通过 <code>zrange</code> 或 <code>zrevrange</code> 命令实现数据的分页读取。在 <code>GetFollow</code> 函数中，我们通过 <code>zrevrange</code> 命令，分页获取到已关注用户的 <code>UserID</code> ，然后去 <code>MySQL</code> 获取对应的用户信息。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(u *User)</span> <span class="title">GetFollow</span><span class="params">(userID <span class="keyword">int64</span>, start, size <span class="keyword">int</span>)</span> <span class="params">([]*model.User, error)</span></span> &#123;</span><br><span class="line">	ctx := context.Background()</span><br><span class="line">	ret := db.Redis.ZRevRange(ctx, util.GetUserFollowKey(userID), <span class="keyword">int64</span>(start), <span class="keyword">int64</span>(start+size))</span><br><span class="line">	<span class="keyword">if</span> err := ret.Err(); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">	&#125;</span><br><span class="line">	ids, err := util.MultiStr2Int64(ret.Val())</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">var</span> users []*model.User</span><br><span class="line">	<span class="keyword">if</span> err := db.MySQL.Table(<span class="string">"user"</span>).Where(<span class="string">"user_id IN (?)"</span>, ids).Find(&amp;users).Error; err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> users, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="查询是否关注指定用户"><a href="#查询是否关注指定用户" class="headerlink" title="查询是否关注指定用户"></a>查询是否关注指定用户</h5><p><code>Redis</code> 在 <code>zset</code> 数据结构中并没有对外提供<strong>查询指定成员是否存在</strong>的接口方法，但我们可通过 <code>zrank</code> 命令查询指定成员的 <code>score</code> 值，当成员不存在时，<code>Redis</code> 就会返回 <code>redis.Nil</code> 的错误，我们即可根据此错误来判断成员是否存在于 <code>zset</code> 中。</p>
<p>遗憾的是，<code>zrank</code> 只能查询单个成员的存在性。因此，对于多个成员存在性的查询，我们可使用 <code>Pipeline</code> 技术，客户端一次将多个查询指令发送至 <code>Redis</code> 统一获得各自查询指令的结果，而不是多次将单个查询指令发送至 <code>Redis</code> ，从而降低网络 IO 次数，提升系统的并发能力。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(u *User)</span> <span class="title">CheckFollow</span><span class="params">(userID <span class="keyword">int64</span>, otherIDs []<span class="keyword">int64</span>)</span> <span class="params">(<span class="keyword">map</span>[<span class="keyword">int64</span>]<span class="keyword">bool</span>, error)</span></span> &#123;</span><br><span class="line">	ctx := context.Background()</span><br><span class="line">	pipe := db.Redis.Pipeline()</span><br><span class="line">	ret := <span class="keyword">map</span>[<span class="keyword">int64</span>]*redis.IntCmd&#123;&#125;</span><br><span class="line">	<span class="keyword">for</span> _, otherID := <span class="keyword">range</span> otherIDs &#123;</span><br><span class="line">		ret[otherID] = pipe.ZRank(ctx, util.GetUserFollowKey(userID), util.Int642Str(otherID))</span><br><span class="line">	&#125;</span><br><span class="line">	_, err := pipe.Exec(ctx)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &amp;&amp; err != redis.Nil &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">	&#125;</span><br><span class="line">	follow := <span class="keyword">map</span>[<span class="keyword">int64</span>]<span class="keyword">bool</span>&#123;&#125;</span><br><span class="line">	<span class="keyword">for</span> otherID, cmd := <span class="keyword">range</span> ret &#123;</span><br><span class="line">		<span class="keyword">if</span> cmd.Err() == redis.Nil &#123;</span><br><span class="line">			follow[otherID] = <span class="literal">false</span></span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			follow[otherID] = <span class="literal">true</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> follow, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="视频-Feed-服务"><a href="#视频-Feed-服务" class="headerlink" title="视频 Feed 服务"></a>视频 Feed 服务</h4><p>视频的 <code>Model</code> 实体定义如下：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Video <span class="keyword">struct</span> &#123;</span><br><span class="line">	ID         <span class="keyword">uint</span>        <span class="string">`gorm:"primary_key"`</span></span><br><span class="line">	VideoID    <span class="keyword">int64</span>       <span class="string">`gorm:"column:video_id"`</span></span><br><span class="line">	OwnerID    <span class="keyword">int64</span>       <span class="string">`gorm:"column:owner_id"`</span></span><br><span class="line">	URL        <span class="keyword">string</span>      <span class="string">`gorm:"column:url"`</span></span><br><span class="line">	ThumbURL   <span class="keyword">string</span>      <span class="string">`gorm:"column:thumb_url"`</span></span><br><span class="line">	Status     VideoStatus <span class="string">`gorm:"column:status"`</span></span><br><span class="line">	Type       VideoType   <span class="string">`gorm:"column:type"`</span></span><br><span class="line">	CreateTime time.Time   <span class="string">`gorm:"column:create_time"`</span></span><br><span class="line">	DeleteTime *time.Time  <span class="string">`gorm:"column:delete_time"`</span></span><br><span class="line">	Digg       <span class="keyword">int</span>         <span class="string">`gorm:"column:digg"`</span></span><br><span class="line">	Comment    <span class="keyword">int</span>         <span class="string">`gorm:"column:comment"`</span></span><br><span class="line">	Username   <span class="keyword">string</span>      <span class="string">`gorm:"-" json:"username"`</span></span><br><span class="line">	Avatar     <span class="keyword">string</span>      <span class="string">`gorm:"-" json:"avatar"`</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="发布视频"><a href="#发布视频" class="headerlink" title="发布视频"></a>发布视频</h5><p>在发布视频的接口实现中，我们先通过 <code>Snowflake</code> 算法生成 ID ，随后创建 <code>model.Video</code> 对象，将其插入至 <code>MySQL</code> 中。在当前的业务逻辑中，客户端需要将视频和视频封面都上传至 <a href="https://github.com/sjqzhang/go-fastdfs" target="_blank" rel="noopener">go-fastdfs</a> 后，获取到视频 <code>url</code> 地址和封面 <code>thumb</code> 地址后，才可调用 <code>Publish</code> 接口方法。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(v *Video)</span> <span class="title">Publish</span><span class="params">(ownerID <span class="keyword">int64</span>, url, thumb <span class="keyword">string</span>, t model.VideoType)</span> <span class="params">(*model.Video, error)</span></span> &#123;</span><br><span class="line">	ctx := context.Background()</span><br><span class="line">	tx := db.MySQL.BeginTx(ctx, <span class="literal">nil</span>)</span><br><span class="line">	<span class="keyword">defer</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">		<span class="keyword">if</span> r := <span class="built_in">recover</span>(); r != <span class="literal">nil</span> &#123;</span><br><span class="line">			tx.Rollback()</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;()</span><br><span class="line">	id, err := util.NextID()</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">	&#125;</span><br><span class="line">	video := model.Video&#123;</span><br><span class="line">		VideoID:    <span class="keyword">int64</span>(id),</span><br><span class="line">		OwnerID:    ownerID,</span><br><span class="line">		URL:        url,</span><br><span class="line">		ThumbURL:   thumb,</span><br><span class="line">		Status:     model.VideoStatusDefault,</span><br><span class="line">		Type:       t,</span><br><span class="line">		CreateTime: time.Now(),</span><br><span class="line">		Digg:       <span class="number">0</span>,</span><br><span class="line">		Comment:    <span class="number">0</span>,</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> err := tx.Table(<span class="string">"video"</span>).Create(&amp;video).Error; err != <span class="literal">nil</span> &#123;</span><br><span class="line">		tx.Rollback()</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">	&#125;</span><br><span class="line">	err = tx.Exec(<span class="string">"UPDATE user SET video = video + 1 WHERE user_id = ?"</span>, ownerID).Error</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		tx.Rollback()</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> &amp;video, tx.Commit().Error</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="视频-Feed-服务-1"><a href="#视频-Feed-服务-1" class="headerlink" title="视频 Feed 服务"></a>视频 Feed 服务</h5><p>以获取已关注用户的视频 Feed 列表为例，我们在 <code>GetFeedFollow</code> 函数中通过 <code>status</code>、<code>type</code>、<code>owner_id</code> 的联合查询，获取对应的 Feed 列表。为了客户端的展示，我们需要为 Feed 列表中的每一个视频查询其发布者的 <code>username</code> 和 <code>avatar</code> 。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(v *Video)</span> <span class="title">GetFeedFollow</span><span class="params">(userID <span class="keyword">int64</span>, start <span class="keyword">int</span>, size <span class="keyword">int</span>)</span> <span class="params">([]*model.Video, error)</span></span> &#123;</span><br><span class="line">	ctx := context.Background()</span><br><span class="line">	ret := db.Redis.ZRevRange(ctx, util.GetUserFollowKey(userID), <span class="keyword">int64</span>(start), <span class="keyword">int64</span>(start+size))</span><br><span class="line">	<span class="keyword">if</span> err := ret.Err(); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">	&#125;</span><br><span class="line">	ids, err := util.MultiStr2Int64(ret.Val())</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">var</span> videos []*model.Video</span><br><span class="line">	err = db.MySQL.Table(<span class="string">"video"</span>).Where(<span class="string">"status = ? AND (type = ? OR type = ?) AND owner_id IN (?)"</span>, model.VideoStatusDefault, model.VideoTypeFollower, model.VideoTypePublic, ids).Order(<span class="string">"create_time DESC"</span>).Offset(start).Limit(size).Find(&amp;videos).Error</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(videos) &gt; <span class="number">0</span> &#123;</span><br><span class="line">		<span class="keyword">var</span> users []*model.User</span><br><span class="line">		err = db.MySQL.Table(<span class="string">"user"</span>).Select(<span class="string">"user_id, username, avatar"</span>).Where(<span class="string">"user_id IN (?)"</span>, ids).Find(&amp;users).Error</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">		&#125;</span><br><span class="line">		m := <span class="keyword">map</span>[<span class="keyword">int64</span>]*model.User&#123;&#125;</span><br><span class="line">		<span class="keyword">for</span> _, user := <span class="keyword">range</span> users &#123;</span><br><span class="line">			m[user.UserID] = user</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">for</span> _, video := <span class="keyword">range</span> videos &#123;</span><br><span class="line">			video.Username = m[video.OwnerID].Username</span><br><span class="line">			video.Avatar = m[video.OwnerID].Avatar</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> videos, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="索引优化"><a href="#索引优化" class="headerlink" title="索引优化"></a>索引优化</h5><p>由于在项目实现中，我们使用<strong>读扩散</strong>的架构，因此相对于 Feed 的写入操作，我们读取 Feed 时的操作是相对比较繁重的。当前，我们有以下 4 种 Feed 列表的查询：</p>
<ol>
<li>个人主页的 Feed 列表查询</li>
<li>已关注用户的 Feed 列表查询</li>
<li>页面 “我的” 的 Feed 列表查询</li>
<li>页面 “发现” 的 Feed 列表查询</li>
</ol>
<p>其中，3 类查询其实是特定的 1 类查询。在各类查询中，我们使用 <code>status</code>、<code>type</code>、<code>owner_id</code> 字段查询，查询结果按 <code>create_time</code> 降序排列，使用 <code>LIMIT</code> 实现数据分页。为了优化 Feed 列表的读取性能，我们需要设计好索引。</p>
<p>考虑到 <code>MySQL</code> 在处理<strong>联合索引</strong>查询时，会使用<strong>最左匹配原则</strong>，我们在 <code>video</code> 表创建了以下<strong>联合索引</strong>：</p>
<ol>
<li><code>idx_owner_id_status_create_time_type</code></li>
<li><code>idx_status_create_time_type_owner_id</code></li>
</ol>
<p>第 1 条索引优化的是 1 类和 3 类查询，第 2 条索引优化的 2 类和 4 类查询。具体的 <code>MySQL Explain</code> 结果如下。</p>
<ul>
<li>个人主页的 Feed 列表查询</li>
</ul>
<p><img src="//cufmheart.github.io/post/Android-Goldfish/query_explain_1.png" alt></p>
<ul>
<li>已关注用户的 Feed 列表查询</li>
</ul>
<p><img src="//cufmheart.github.io/post/Android-Goldfish/query_explain_2.png" alt></p>
<ul>
<li>页面 “我的” 的 Feed 列表查询</li>
</ul>
<p><img src="//cufmheart.github.io/post/Android-Goldfish/query_explain_3.png" alt></p>
<ul>
<li>页面 “发现” 的 Feed 列表查询</li>
</ul>
<p><img src="//cufmheart.github.io/post/Android-Goldfish/query_explain_4.png" alt></p>
<h4 id="评论服务"><a href="#评论服务" class="headerlink" title="评论服务"></a>评论服务</h4><p>评论的 <code>Model</code> 实体定义如下：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Comment <span class="keyword">struct</span> &#123;</span><br><span class="line">	ID         <span class="keyword">uint</span>          <span class="string">`gorm:"primary_key"`</span></span><br><span class="line">	CommentID  <span class="keyword">int64</span>         <span class="string">`gorm:"column:comment_id"`</span></span><br><span class="line">	VideoID    <span class="keyword">int64</span>         <span class="string">`gorm:"column:video_id"`</span></span><br><span class="line">	UserID     <span class="keyword">int64</span>         <span class="string">`gorm:"column:user_id"`</span></span><br><span class="line">	Content    <span class="keyword">string</span>        <span class="string">`gorm:"column:content"`</span></span><br><span class="line">	Status     CommentStatus <span class="string">`gorm:"column:status"`</span></span><br><span class="line">	CreateTime time.Time     <span class="string">`gorm:"column:create_time"`</span></span><br><span class="line">	DeleteTime *time.Time    <span class="string">`gorm:"column:delete_time"`</span></span><br><span class="line">	Digg       <span class="keyword">int</span>           <span class="string">`gorm:"column:digg"`</span></span><br><span class="line">	Username   <span class="keyword">string</span>        <span class="string">`gorm:"-" json:"username"`</span></span><br><span class="line">	Avatar     <span class="keyword">string</span>        <span class="string">`gorm:"-" json:"avatar"`</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="发表评论"><a href="#发表评论" class="headerlink" title="发表评论"></a>发表评论</h5><p>在发表评论的接口实现中，我们先通过 <code>Snowflake</code> 算法生成 ID ，随后创建 <code>model.Comment</code> 对象，将其插入至 <code>MySQL</code> 中。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(v *Video)</span> <span class="title">Comment</span><span class="params">(userID, videoID <span class="keyword">int64</span>, content <span class="keyword">string</span>)</span> <span class="params">(*model.Comment, error)</span></span> &#123;</span><br><span class="line">	commentID, err := util.NextID()</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">	&#125;</span><br><span class="line">	ctx := context.Background()</span><br><span class="line">	tx := db.MySQL.BeginTx(ctx, <span class="literal">nil</span>)</span><br><span class="line">	<span class="keyword">var</span> user model.User</span><br><span class="line">	<span class="keyword">if</span> err := tx.Table(<span class="string">"user"</span>).Select(<span class="string">"1"</span>).Where(<span class="string">"user_id = ?"</span>, userID).First(&amp;user).Error; err != <span class="literal">nil</span> &#123;</span><br><span class="line">		tx.Rollback()</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">var</span> video model.Video</span><br><span class="line">	<span class="keyword">if</span> err := tx.Table(<span class="string">"video"</span>).Select(<span class="string">"owner_id"</span>).Where(<span class="string">"video_id = ?"</span>, videoID).First(&amp;video).Error; err != <span class="literal">nil</span> &#123;</span><br><span class="line">		tx.Rollback()</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">	&#125;</span><br><span class="line">	now := time.Now()</span><br><span class="line">	comment := model.Comment&#123;</span><br><span class="line">		CommentID:  <span class="keyword">int64</span>(commentID),</span><br><span class="line">		VideoID:    videoID,</span><br><span class="line">		UserID:     userID,</span><br><span class="line">		Content:    content,</span><br><span class="line">		Status:     model.CommentStatusDefault,</span><br><span class="line">		CreateTime: now,</span><br><span class="line">		Digg:       <span class="number">0</span>,</span><br><span class="line">		Username:   user.Username,</span><br><span class="line">		Avatar:     user.Avatar,</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> err := tx.Table(<span class="string">"comment"</span>).Create(&amp;comment).Error; err != <span class="literal">nil</span> &#123;</span><br><span class="line">		tx.Rollback()</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> err := tx.Exec(<span class="string">"UPDATE video SET comment = comment + 1 WHERE video_id = ?"</span>, videoID).Error; err != <span class="literal">nil</span> &#123;</span><br><span class="line">		tx.Rollback()</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> &amp;comment, tx.Commit().Error</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="点赞服务"><a href="#点赞服务" class="headerlink" title="点赞服务"></a>点赞服务</h4><h5 id="点赞视频"><a href="#点赞视频" class="headerlink" title="点赞视频"></a>点赞视频</h5><p>在点赞服务的实现中，我们使用 <code>zset</code> 数据结构来实现用户点赞了哪些视频、视频被哪些用户点赞的业务逻辑。由于我们在 <code>MySQL</code> 中维护了视频的点赞总数信息，因此该部分的逻辑由 <code>Redis TxPipeline</code> 和 <code>MySQL Transaction</code> 两部分构成。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(v *Video)</span> <span class="title">Digg</span><span class="params">(userID <span class="keyword">int64</span>, videoID <span class="keyword">int64</span>, digg <span class="keyword">bool</span>)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">    ctx := context.Background()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Redis 事务</span></span><br><span class="line">	pipe := db.Redis.TxPipeline()</span><br><span class="line">	<span class="keyword">var</span> ret *redis.IntCmd</span><br><span class="line">    now := <span class="keyword">float64</span>(time.Now().Unix())</span><br><span class="line">	<span class="keyword">if</span> digg &#123;</span><br><span class="line">		ret = pipe.ZAdd(ctx, util.GetVideoDiggKey(videoID), &amp;redis.Z&#123;Score: now, Member: userID&#125;)</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		ret = pipe.ZRem(ctx, util.GetVideoDiggKey(videoID), userID)</span><br><span class="line">	&#125;</span><br><span class="line">	_, err := pipe.Exec(ctx)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> err</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> ret.Val() == <span class="number">1</span> &#123;</span><br><span class="line">        <span class="comment">// MySQL 事务</span></span><br><span class="line">		tx := db.MySQL.BeginTx(ctx, <span class="literal">nil</span>)</span><br><span class="line">		<span class="keyword">defer</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">			<span class="keyword">if</span> r := <span class="built_in">recover</span>(); r != <span class="literal">nil</span> &#123;</span><br><span class="line">				tx.Rollback()</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;()</span><br><span class="line">		<span class="keyword">var</span> video model.Video</span><br><span class="line">		<span class="keyword">if</span> err := tx.Table(<span class="string">"video"</span>).Where(<span class="string">"video_id = ?"</span>, videoID).First(&amp;video).Error; err != <span class="literal">nil</span> &#123;</span><br><span class="line">			tx.Rollback()</span><br><span class="line">			<span class="keyword">return</span> err</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">var</span> updateVideoSQL <span class="keyword">string</span></span><br><span class="line">		<span class="keyword">var</span> updateUserSQL <span class="keyword">string</span></span><br><span class="line">		<span class="keyword">if</span> digg &#123;</span><br><span class="line">			updateVideoSQL = <span class="string">"UPDATE video SET digg = digg + 1 WHERE video_id = ?"</span></span><br><span class="line">			updateUserSQL = <span class="string">"UPDATE user SET digg = digg + 1 WHERE user_id = ?"</span></span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			updateVideoSQL = <span class="string">"UPDATE video SET digg = digg - 1 WHERE video_id = ?"</span></span><br><span class="line">			updateUserSQL = <span class="string">"UPDATE user SET digg = digg - 1 WHERE user_id = ?"</span></span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> err := tx.Exec(updateVideoSQL, videoID).Error; err != <span class="literal">nil</span> &#123;</span><br><span class="line">			tx.Rollback()</span><br><span class="line">			<span class="keyword">return</span> err</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> err := tx.Exec(updateUserSQL, video.OwnerID).Error; err != <span class="literal">nil</span> &#123;</span><br><span class="line">			tx.Rollback()</span><br><span class="line">			<span class="keyword">return</span> err</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> tx.Commit().Error</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="查询是否点赞指定视频"><a href="#查询是否点赞指定视频" class="headerlink" title="查询是否点赞指定视频"></a>查询是否点赞指定视频</h5><p>为了实现查询某个用户是否点赞了指定视频的接口，我们借助 <code>Redis Pipeline</code> 和 <code>zrank</code> 实现了 <code>CheckDigg</code> 函数。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(v *Video)</span> <span class="title">CheckDigg</span><span class="params">(userID <span class="keyword">int64</span>, videoIDs []<span class="keyword">int64</span>)</span> <span class="params">(<span class="keyword">map</span>[<span class="keyword">int64</span>]<span class="keyword">bool</span>, error)</span></span> &#123;</span><br><span class="line">	ctx := context.Background()</span><br><span class="line">	pipe := db.Redis.Pipeline()</span><br><span class="line">	ret := <span class="keyword">map</span>[<span class="keyword">int64</span>]*redis.IntCmd&#123;&#125;</span><br><span class="line">	<span class="keyword">for</span> _, videoID := <span class="keyword">range</span> videoIDs &#123;</span><br><span class="line">		ret[videoID] = pipe.ZRank(ctx, util.GetVideoDiggKey(videoID), util.Int642Str(userID))</span><br><span class="line">	&#125;</span><br><span class="line">	_, err := pipe.Exec(ctx)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &amp;&amp; err != redis.Nil &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">	&#125;</span><br><span class="line">	digg := <span class="keyword">map</span>[<span class="keyword">int64</span>]<span class="keyword">bool</span>&#123;&#125;</span><br><span class="line">	<span class="keyword">for</span> videoID, cmd := <span class="keyword">range</span> ret &#123;</span><br><span class="line">		<span class="keyword">if</span> cmd.Err() == redis.Nil &#123;</span><br><span class="line">			digg[videoID] = <span class="literal">false</span></span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			digg[videoID] = <span class="literal">true</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> digg, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="用户动态消息服务"><a href="#用户动态消息服务" class="headerlink" title="用户动态消息服务"></a>用户动态消息服务</h4><p>在当前项目中，我们希望当一个用户获得了新的关注时、其发布的视频获得了点赞或评论时，该用户可以在客户端上看到这些动态消息。我们使用 <code>ActivityType</code> 类型来区分动态消息的不同触发操作，<code>ActivityTypeFollow</code> 表示由关注事件触发的动态消息，<code>ActivityTypeDigg</code> 表示由点赞事件触发的动态消息类型，<code>ActivityTypeComment</code> 表示由评论事件触发的动态消息类型。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> ActivityType <span class="keyword">int</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> (</span><br><span class="line">	ActivityTypeFollow ActivityType = <span class="literal">iota</span></span><br><span class="line">	ActivityTypeDigg</span><br><span class="line">	ActivityTypeComment</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p>由于我们需要在用户在进行<strong>关注</strong>、<strong>点赞</strong>、<strong>评论</strong>操作时，触发用户动态消息，因此我们需要在这些逻辑上添加动态消息的生成逻辑（使用 <code>MySQL</code> 事务）。例如，在下面的 <code>Comment</code> 函数中，我们在原有的发布评论的逻辑上，添加了 <code>model.Activity</code> 的插入逻辑。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(v *Video)</span> <span class="title">Comment</span><span class="params">(userID, videoID <span class="keyword">int64</span>, content <span class="keyword">string</span>)</span> <span class="params">(*model.Comment, error)</span></span> &#123;</span><br><span class="line">	commentID, err := util.NextID()</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">	&#125;</span><br><span class="line">	activityID, err := util.NextID()</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">	&#125;</span><br><span class="line">	ctx := context.Background()</span><br><span class="line">	tx := db.MySQL.BeginTx(ctx, <span class="literal">nil</span>)</span><br><span class="line">	<span class="keyword">var</span> user model.User</span><br><span class="line">	<span class="keyword">if</span> err := tx.Table(<span class="string">"user"</span>).Select(<span class="string">"username, avatar"</span>).Where(<span class="string">"user_id = ?"</span>, userID).First(&amp;user).Error; err != <span class="literal">nil</span> &#123;</span><br><span class="line">		tx.Rollback()</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">var</span> video model.Video</span><br><span class="line">	<span class="keyword">if</span> err := tx.Table(<span class="string">"video"</span>).Select(<span class="string">"owner_id"</span>).Where(<span class="string">"video_id = ?"</span>, videoID).First(&amp;video).Error; err != <span class="literal">nil</span> &#123;</span><br><span class="line">		tx.Rollback()</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">	&#125;</span><br><span class="line">	now := time.Now()</span><br><span class="line">	comment := model.Comment&#123;</span><br><span class="line">		CommentID:  <span class="keyword">int64</span>(commentID),</span><br><span class="line">		VideoID:    videoID,</span><br><span class="line">		UserID:     userID,</span><br><span class="line">		Content:    content,</span><br><span class="line">		Status:     model.CommentStatusDefault,</span><br><span class="line">		CreateTime: now,</span><br><span class="line">		Digg:       <span class="number">0</span>,</span><br><span class="line">		Username:   user.Username,</span><br><span class="line">		Avatar:     user.Avatar,</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> err := tx.Table(<span class="string">"comment"</span>).Create(&amp;comment).Error; err != <span class="literal">nil</span> &#123;</span><br><span class="line">		tx.Rollback()</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> err := tx.Exec(<span class="string">"UPDATE video SET comment = comment + 1 WHERE video_id = ?"</span>, videoID).Error; err != <span class="literal">nil</span> &#123;</span><br><span class="line">		tx.Rollback()</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">	&#125;</span><br><span class="line">	activity := model.Activity&#123;</span><br><span class="line">		ActivityID:     <span class="keyword">int64</span>(activityID),</span><br><span class="line">		UserID:         video.OwnerID,</span><br><span class="line">		Type:           model.ActivityTypeComment,</span><br><span class="line">		CreateTime:     now,</span><br><span class="line">		RelatedVideoID: videoID,</span><br><span class="line">		RelatedUserID:  userID,</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> err := tx.Table(<span class="string">"activity"</span>).Create(&amp;activity).Error; err != <span class="literal">nil</span> &#123;</span><br><span class="line">		tx.Rollback()</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> &amp;comment, tx.Commit().Error</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

    </article>
    <!-- license  -->
    
    <!-- paginator  -->
    <ul class="post-paginator">
        <li class="previous">
            
                <div class="prevSlogan">上一篇文章</div>
                <a href= "/post/ST8-NextDate问题等价类划分/" title= "ST8 - NextDate 问题等价类划分">
                    <div class="prevTitle">ST8 - NextDate 问题等价类划分</div>
                </a>
            
        </li>
        <li class="next">
            
                <div class="nextSlogan">继续阅读下一篇</div>
                <a href= "/post/LeetCode-剑指Offer-Part1/" title= "LeetCode - 剑指Offer - Part1">
                    <div class="nextTitle">LeetCode - 剑指Offer - Part1</div>
                </a>
            
        </li>
    </ul>
    <!-- 评论插件 -->
    <!-- 来必力City版安装代码 -->

<!-- City版安装代码已完成 -->
    
    
    <!-- gitalk评论 -->

    <!-- utteranc评论 -->

    <!-- partial('_partial/comment/changyan') -->
    <!--PC版-->


    
    

    <!-- 评论 -->
</main>
            <!-- profile -->
            
        </div>
        <footer class="footer footer-unloaded">
    <!-- social  -->
    <!-- 
    <div class="social">
        
    
        
            
                <a href="mailto:wen.hl@foxmail.com" class="iconfont-archer email" title=email ></a>
            
        
    
        
            
                <a href="//github.com/CUFMHeart" class="iconfont-archer github" target="_blank" title=github></a>
            
        
    
        
    
        
    
        
    
        
            
                <a href="https://cufmheart.github.io/" class="iconfont-archer weibo" target="_blank" title=weibo></a>
            
        
    
        
    
        
            
                <a href="https://cufmheart.github.io/" class="iconfont-archer douban" target="_blank" title=douban></a>
            
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
            
                <a href="https://cufmheart.github.io/" class="iconfont-archer others" target="_blank" title=others></a>
            
        
    
        
    
        
            
                <a href="https://cufmheart.github.io/" class="iconfont-archer rss" target="_blank" title=rss></a>
            
        
    

    </div>
     -->

    <!-- powered by Hexo  -->
    <!-- <div class="copyright"> -->
        <!-- <span id="hexo-power">- W -</span> -->
        <!-- <span id="hexo-power">Powered by <a href="https://hexo.io/" target="_blank">Hexo</a></span><span class="iconfont-archer power">&#xe635;</span><span id="theme-info">theme <a href="https://github.com/fi3ework/hexo-theme-archer" target="_blank">Archer</a></span> -->
    <!-- </div> -->
    
    <!-- 不蒜子  -->
    
    <div class="busuanzi-container">
    
    <span id="busuanzi_container_site_pv">☺</span>
    <!-- 
    <span id="busuanzi_container_site_uv">:)<span id="busuanzi_value_site_uv"></span></span>
     -->
    </div>
    
</footer>
    </div>
    <!-- toc -->
    
    <div class="toc-wrapper" style=
    







top:40vh;

    >
        <div class="toc-catalog">
            <span class="iconfont-archer catalog-icon">&#xe613;</span><span>CATALOG</span>
        </div>
        <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Android-Goldfish"><span class="toc-number">1.</span> <span class="toc-text">Android - Goldfish</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#简介"><span class="toc-number">1.1.</span> <span class="toc-text">简介</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#开发环境"><span class="toc-number">1.2.</span> <span class="toc-text">开发环境</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#功能信息"><span class="toc-number">1.3.</span> <span class="toc-text">功能信息</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#使用说明"><span class="toc-number">1.4.</span> <span class="toc-text">使用说明</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#应用部署"><span class="toc-number">1.4.1.</span> <span class="toc-text">应用部署</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#服务端部署"><span class="toc-number">1.4.1.1.</span> <span class="toc-text">服务端部署</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#客户端使用"><span class="toc-number">1.4.1.2.</span> <span class="toc-text">客户端使用</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#应用截图"><span class="toc-number">1.4.2.</span> <span class="toc-text">应用截图</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#重点-amp-难点"><span class="toc-number">1.5.</span> <span class="toc-text">重点&amp;难点</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#用户关系服务"><span class="toc-number">1.5.1.</span> <span class="toc-text">用户关系服务</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#读扩散与写扩散"><span class="toc-number">1.5.2.</span> <span class="toc-text">读扩散与写扩散</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#实现方法"><span class="toc-number">1.6.</span> <span class="toc-text">实现方法</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#客户端"><span class="toc-number">1.6.1.</span> <span class="toc-text">客户端</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#技术选型"><span class="toc-number">1.6.1.1.</span> <span class="toc-text">技术选型</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#源代码文件结构"><span class="toc-number">1.6.1.2.</span> <span class="toc-text">源代码文件结构</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#MVVM-模式"><span class="toc-number">1.6.1.3.</span> <span class="toc-text">MVVM 模式</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#DataBinding"><span class="toc-number">1.6.1.4.</span> <span class="toc-text">DataBinding</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#事件驱动"><span class="toc-number">1.6.1.5.</span> <span class="toc-text">事件驱动</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#头像"><span class="toc-number">1.6.1.6.</span> <span class="toc-text">头像</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Feed-流"><span class="toc-number">1.6.1.7.</span> <span class="toc-text">Feed 流</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#视频播放页"><span class="toc-number">1.6.1.8.</span> <span class="toc-text">视频播放页</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#删除评论"><span class="toc-number">1.6.1.8.1.</span> <span class="toc-text">删除评论</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#登录注册页"><span class="toc-number">1.6.1.9.</span> <span class="toc-text">登录注册页</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#主页面"><span class="toc-number">1.6.1.10.</span> <span class="toc-text">主页面</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#发现页"><span class="toc-number">1.6.1.11.</span> <span class="toc-text">发现页</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#消息页"><span class="toc-number">1.6.1.12.</span> <span class="toc-text">消息页</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#用户页"><span class="toc-number">1.6.1.13.</span> <span class="toc-text">用户页</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#个人主页"><span class="toc-number">1.6.1.14.</span> <span class="toc-text">个人主页</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#视频发布页"><span class="toc-number">1.6.1.15.</span> <span class="toc-text">视频发布页</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#服务端"><span class="toc-number">1.6.2.</span> <span class="toc-text">服务端</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#技术选型-1"><span class="toc-number">1.6.2.1.</span> <span class="toc-text">技术选型</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#源代码文件结构-1"><span class="toc-number">1.6.2.2.</span> <span class="toc-text">源代码文件结构</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#数据库设计"><span class="toc-number">1.6.2.3.</span> <span class="toc-text">数据库设计</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ID-生成策略"><span class="toc-number">1.6.2.4.</span> <span class="toc-text">ID 生成策略</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#用户关系服务-1"><span class="toc-number">1.6.2.5.</span> <span class="toc-text">用户关系服务</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#关注与取消关注"><span class="toc-number">1.6.2.5.1.</span> <span class="toc-text">关注与取消关注</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#关注列表与粉丝列表"><span class="toc-number">1.6.2.5.2.</span> <span class="toc-text">关注列表与粉丝列表</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#查询是否关注指定用户"><span class="toc-number">1.6.2.5.3.</span> <span class="toc-text">查询是否关注指定用户</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#视频-Feed-服务"><span class="toc-number">1.6.2.6.</span> <span class="toc-text">视频 Feed 服务</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#发布视频"><span class="toc-number">1.6.2.6.1.</span> <span class="toc-text">发布视频</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#视频-Feed-服务-1"><span class="toc-number">1.6.2.6.2.</span> <span class="toc-text">视频 Feed 服务</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#索引优化"><span class="toc-number">1.6.2.6.3.</span> <span class="toc-text">索引优化</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#评论服务"><span class="toc-number">1.6.2.7.</span> <span class="toc-text">评论服务</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#发表评论"><span class="toc-number">1.6.2.7.1.</span> <span class="toc-text">发表评论</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#点赞服务"><span class="toc-number">1.6.2.8.</span> <span class="toc-text">点赞服务</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#点赞视频"><span class="toc-number">1.6.2.8.1.</span> <span class="toc-text">点赞视频</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#查询是否点赞指定视频"><span class="toc-number">1.6.2.8.2.</span> <span class="toc-text">查询是否点赞指定视频</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#用户动态消息服务"><span class="toc-number">1.6.2.9.</span> <span class="toc-text">用户动态消息服务</span></a></li></ol></li></ol></li></ol></li></ol>
    </div>
    
    <div class="back-top iconfont-archer">&#xe639;</div>
    <div class="sidebar sidebar-hide">
    <ul class="sidebar-tabs sidebar-tabs-active-0">
        <li class="sidebar-tab-archives"><span class="iconfont-archer">&#xe67d;</span><span class="tab-name">Archive</span></li>
        <li class="sidebar-tab-tags"><span class="iconfont-archer">&#xe61b;</span><span class="tab-name">Tag</span></li>
        <li class="sidebar-tab-categories"><span class="iconfont-archer">&#xe666;</span><span class="tab-name">Cate</span></li>
    </ul>
    <div class="sidebar-content sidebar-content-show-archive">
          <div class="sidebar-panel-archives">
    <!-- 在ejs中将archive按照时间排序 -->
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    <div class="total-and-search">
        <div class="total-archive">
        Total : 24
        </div>
        <!-- search  -->
        
    </div>
    
    <div class="post-archive">
    
    
    
    
    <div class="archive-year"> 2020 </div>
    <ul class="year-list">
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">09/05</span><a class="archive-post-title" href= "/post/LeetCode-剑指Offer-Part4/" >LeetCode - 剑指Offer - Part3</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">09/04</span><a class="archive-post-title" href= "/post/LeetCode-剑指Offer-Part3/" >LeetCode - 剑指Offer - Part3</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">09/03</span><a class="archive-post-title" href= "/post/LeetCode-剑指Offer-Part2/" >LeetCode - 剑指Offer - Part2</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">09/01</span><a class="archive-post-title" href= "/post/LeetCode-剑指Offer-Part1/" >LeetCode - 剑指Offer - Part1</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">08/01</span><a class="archive-post-title" href= "/post/Android-Goldfish/" >Android - Goldfish</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">07/06</span><a class="archive-post-title" href= "/post/ST8-NextDate问题等价类划分/" >ST8 - NextDate 问题等价类划分</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">07/05</span><a class="archive-post-title" href= "/post/ST7-三角形问题等价类划分/" >ST7 - 三角形问题等价类划分</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">07/04</span><a class="archive-post-title" href= "/post/ST6-黑盒测试判定表法/" >ST6 - 黑盒测试判定表法</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">07/03</span><a class="archive-post-title" href= "/post/ST5-程序控制流图/" >ST5 - 程序控制流图</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">06/11</span><a class="archive-post-title" href= "/post/ST4-Halstead复杂度计算/" >ST4 - Halstead 复杂度计算</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">06/01</span><a class="archive-post-title" href= "/post/ST3-软件生命周期测试概述/" >ST3 - 软件生命周期测试概述</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">05/15</span><a class="archive-post-title" href= "/post/ST2-敏捷宣言12原则/" >ST2 - 敏捷宣言 12 原则</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">05/01</span><a class="archive-post-title" href= "/post/ST1-原型方法与生命周期/" >ST1 - 原型方法与生命周期</a>
        </li>
    
    
    
    
    
        </ul>
    
    <div class="archive-year"> 2019 </div>
    <ul class="year-list">
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">12/19</span><a class="archive-post-title" href= "/post/3dG11-AR-MR技术/" >3D Game 11 - AR/MR 技术</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">12/06</span><a class="archive-post-title" href= "/post/3dG10-游戏智能/" >3D Game 10 - 游戏智能</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">11/20</span><a class="archive-post-title" href= "/post/3dG9-UI系统/" >3D Game 9 - UI 系统</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">11/04</span><a class="archive-post-title" href= "/post/3dG8-粒子系统/" >3D Game 8 - 粒子系统</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">10/25</span><a class="archive-post-title" href= "/post/3dG7-模型与动画/" >3D Game 7 - 模型与动画</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">10/18</span><a class="archive-post-title" href= "/post/3dG6-物理系统与碰撞/" >3D Game 6 - 物理系统与碰撞</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">10/09</span><a class="archive-post-title" href= "/post/3dG5-与游戏世界交互/" >3D Game 5 - 与游戏世界交互</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">10/02</span><a class="archive-post-title" href= "/post/3dG4-游戏对象与图形基础/" >3D Game 4 - 游戏对象与图形基础</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">09/20</span><a class="archive-post-title" href= "/post/3dG3-空间与运动/" >3D Game 3 - 空间与运动</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">09/10</span><a class="archive-post-title" href= "/post/3dG2-离散仿真引擎基础/" >3D Game 2 - 离散仿真引擎基础</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">09/04</span><a class="archive-post-title" href= "/post/3dG1-World-of-Goo/" >3D Game 1 - World of Goo</a>
        </li>
    
    </div>
  </div>
        <div class="sidebar-panel-tags">
    <div class="sidebar-tags-name">
    
        <span class="sidebar-tag-name" data-tags="3D-Game-Programming&Design"><span class="iconfont-archer">&#xe606;</span>3D-Game-Programming&Design</span>
    
        <span class="sidebar-tag-name" data-tags="SYSU-Course"><span class="iconfont-archer">&#xe606;</span>SYSU-Course</span>
    
        <span class="sidebar-tag-name" data-tags="AR/MR"><span class="iconfont-archer">&#xe606;</span>AR/MR</span>
    
        <span class="sidebar-tag-name" data-tags="LeetCode"><span class="iconfont-archer">&#xe606;</span>LeetCode</span>
    
        <span class="sidebar-tag-name" data-tags="剑指Offer"><span class="iconfont-archer">&#xe606;</span>剑指Offer</span>
    
        <span class="sidebar-tag-name" data-tags="Software-Testing"><span class="iconfont-archer">&#xe606;</span>Software-Testing</span>
    
    </div>
    <div class="iconfont-archer sidebar-tags-empty">&#xe678;</div>
    <div class="tag-load-fail" style="display: none; color: #ccc; font-size: 0.6rem;">
    缺失模块。<br/>
    1、请确保node版本大于6.2<br/>
    2、在博客根目录（注意不是archer根目录）执行以下命令：<br/>
    <span style="color: #008B8B; font-size: 1rem; line-height: 2rem;">npm i hexo-generator-json-content --save</span><br/>
    3、在根目录_config.yml里添加配置：
    <pre style="color: #787878; font-size: 0.6rem;">
jsonContent:
  meta: false
  pages: false
  posts:
    title: true
    date: true
    path: true
    text: false
    raw: false
    content: false
    slug: false
    updated: false
    comments: false
    link: false
    permalink: false
    excerpt: false
    categories: true
    tags: true</pre>
    </div> 
    <div class="sidebar-tags-list"></div>
</div>
        <div class="sidebar-panel-categories">
    <div class="sidebar-categories-name">
    
        <span class="sidebar-category-name" data-categories="3D-Game-Programming-Design"><span class="iconfont-archer">&#xe60a;</span>3D-Game-Programming-Design</span>
    
        <span class="sidebar-category-name" data-categories="Programming"><span class="iconfont-archer">&#xe60a;</span>Programming</span>
    
        <span class="sidebar-category-name" data-categories="Software-Testing"><span class="iconfont-archer">&#xe60a;</span>Software-Testing</span>
    
    </div>
    <div class="iconfont-archer sidebar-categories-empty">&#xe678;</div>
    <div class="sidebar-categories-list"></div>
</div>
    </div>
</div> 
    <script>
    var siteMeta = {
        root: "/",
        author: "CUFMH2"
    }
</script>
    <!-- CDN failover -->
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script>
    <script type="text/javascript">
        if (typeof window.$ === 'undefined')
        {
            console.warn('jquery load from jsdelivr failed, will load local script')
            document.write('<script src="/lib/jquery.min.js">\x3C/script>')
        }
    </script>
    <script src="/scripts/main.js"></script>
    <!-- algolia -->
    
    <!-- busuanzi  -->
    
    <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    
    <!-- CNZZ  -->
    
    </div>
    <!-- async load share.js -->
    
        <script src="/scripts/share.js" async></script>    
     
    <script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        tex2jax: {
            inlineMath: [ ["$","$"], ["\\(","\\)"] ],
            skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code'],
            processEscapes: true
        }
    });
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax();
        for (var i = 0; i < all.length; ++i)
            all[i].SourceElement().parentNode.className += ' has-jax';
    });
</script>
<!-- <script src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script> -->

<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-MML-AM_CHTML"></script>
</body>
</html>


